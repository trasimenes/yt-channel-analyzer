{% extends "base.html" %}

{% block title %}Debug Tools - YT Analyzer{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="bi bi-bug text-danger me-3"></i>
                        Debug Tools
                    </h1>
                    <p class="text-muted mb-0">Technical tools for system maintenance, propagation, and debugging</p>
                </div>

                {% if message %}
                <div class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                <!-- Status Overview Section -->
                <div class="card settings-card mb-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>
                            Dernières Propagations - Logs de la Base
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info alert-custom" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Historique des actions de propagation</strong>
                            <p class="mb-0 mt-2">Ces dates proviennent directement des logs stockés en base de données.</p>
                        </div>
                        
                        <div class="row">
                            <!-- Propagation des Patterns -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">
                                            <i class="bi bi-arrow-repeat me-2"></i>
                                            Propagation Patterns
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="propagation-status" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2 text-muted">Chargement...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Re-classification -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0">
                                            <i class="bi bi-robot me-2"></i>
                                            Re-classification
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="reclassification-status" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-warning" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2 text-muted">Chargement...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Classification IA Playlists -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="mb-0">
                                            <i class="bi bi-collection-play me-2"></i>
                                            Classification IA
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="ai-classification-status" class="text-center">
                                            <div class="spinner-border spinner-border-sm text-success" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <div class="mt-2 text-muted">Chargement...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section Propagation des patterns multilingues -->
                <div class="card settings-card mb-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-arrows-angle-expand me-2"></i>
                            Propagation des patterns multilingues
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info alert-custom" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Cette fonction met à jour tous les endroits du site qui utilisent la classification HERO/HUB/HELP</strong>
                            <ul class="mt-2 mb-0">
                                <li>Re-classifie toutes les vidéos existantes avec la nouvelle logique multilingue</li>
                                <li>Met à jour les fonctions de classification dans tout le code</li>
                                <li>Applique la détection automatique de langue aux analyses</li>
                            </ul>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-gear me-2"></i>
                                    Actions disponibles
                                </h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary-modern" onclick="propagatePatterns()">
                                        <i class="bi bi-arrow-repeat me-2"></i>
                                        Propager les patterns multilingues
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="reclassifyAllVideos()">
                                        <i class="bi bi-robot me-2"></i>
                                        Re-classifier toutes les vidéos
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="updateClassificationLogic()">
                                        <i class="bi bi-code-slash me-2"></i>
                                        Mettre à jour la logique de classification
                                    </button>
                                    <button type="button" class="btn btn-outline-danger" onclick="resetPropagation()">
                                        <i class="bi bi-stop me-2"></i>
                                        Reset / Arrêter
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Statut actuel
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Patterns</div>
                                            <span class="badge bg-warning" id="patterns-status">À vérifier</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Classification</div>
                                            <span class="badge bg-warning" id="classification-status">À vérifier</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div id="propagation-progress" class="mb-3" style="display: none;">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%" id="progress-bar"></div>
                                </div>
                                <div class="text-center mt-2">
                                    <small class="text-muted" id="progress-text">Initialisation...</small>
                                </div>
                            </div>
                            
                            <div id="propagation-log" class="mt-3" style="display: none;">
                                <h6 class="text-secondary">
                                    <i class="bi bi-terminal me-2"></i>
                                    Log de propagation
                                </h6>
                                <div class="border rounded p-3 bg-light" style="height: 200px; overflow-y: auto;">
                                    <pre id="log-content" class="mb-0" style="font-size: 0.85rem;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Classification Section -->
                <div class="card settings-card mb-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-robot me-2"></i>
                            Classification automatique HERO/HUB/HELP
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info alert-custom" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Classifier automatiquement les vidéos non classifiées</strong>
                            <p class="mb-0 mt-2">Utilise la logique multilingue pour classifier les vidéos qui n'ont pas encore de catégorie HERO/HUB/HELP.</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-gear me-2"></i>
                                    Actions disponibles
                                </h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary-modern" onclick="classifyAllUnclassified()">
                                        <i class="bi bi-robot me-2"></i>
                                        Classifier toutes les vidéos non classifiées
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="runGlobalAiClassification()">
                                        <i class="bi bi-collection-play me-2"></i>
                                        Classification IA globale (Playlists + Vidéos)
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="updateDatabaseSchemaWithHumanProtection()">
                                        <i class="bi bi-shield-check me-2"></i>
                                        Mise à jour BDD - Protection supervision humaine
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="checkClassificationStatus()">
                                        <i class="bi bi-search me-2"></i>
                                        Vérifier le statut de classification
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Statistiques de classification
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Vidéos classifiées</div>
                                            <div class="h5 mb-0 text-success" id="classified-videos">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Non classifiées</div>
                                            <div class="h5 mb-0 text-warning" id="unclassified-videos">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Classification Results -->
                        <div id="classification-results" class="mt-4" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Résultats de classification
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="classification-details">
                                        <!-- Résultats seront peuplés ici -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Database Sync Section -->
                <div class="card settings-card mb-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-database me-2"></i>
                            Database Synchronization
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning alert-custom" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Synchronize competitor data between cache and database</strong>
                            <p class="mb-0 mt-2">Ensure all competitor data is properly stored and accessible across the application.</p>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="display-6 mb-2">💾</div>
                                    <h6 class="text-secondary">Cache Status</h6>
                                    <div id="cache-status" class="h4 text-primary">-</div>
                                    <small class="text-muted">competitors in cache</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="display-6 mb-2">🗄️</div>
                                    <h6 class="text-secondary">Database Status</h6>
                                    <div id="db-status" class="h4 text-success">-</div>
                                    <small class="text-muted">competitors in database</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-3 bg-light rounded">
                                    <div class="display-6 mb-2">⚠️</div>
                                    <h6 class="text-secondary">Sync Needed</h6>
                                    <div id="sync-needed" class="h4 text-warning">-</div>
                                    <small class="text-muted">competitors missing from DB</small>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row g-3">
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary-modern w-100" onclick="checkCompetitorStatus()">
                                    <i class="bi bi-search me-2"></i>
                                    Check Status
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-warning-modern w-100" onclick="updateDatabaseSchema()">
                                    <i class="bi bi-database-gear me-2"></i>
                                    Update Schema
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary-modern w-100" onclick="syncCompetitorsToDb()" id="sync-btn">
                                    <i class="bi bi-cloud-arrow-up me-2"></i>
                                    Sync to Database
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-outline-secondary-modern w-100" onclick="cleanDuplicateCompetitors()">
                                    <i class="bi bi-trash me-2"></i>
                                    Clean Duplicates
                                </button>
                            </div>
                        </div>

                        <!-- Sync Results -->
                        <div id="sync-results" class="mt-4" style="display: none;">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Résultats de synchronisation
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="sync-details">
                                        <!-- Résultats seront peuplés ici -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Integrity Section -->
                <div class="card settings-card">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check me-2"></i>
                            Data Integrity Analysis
                        </h5>
                    </div>
                    <div class="card-body" id="inconsistencies-section">
                        <div class="alert alert-danger alert-custom" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Detect and analyze data inconsistencies</strong>
                            <p class="mb-0 mt-2">Run various checks to identify missing data, duplicates, and anomalies in your competitor database.</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-search me-2"></i>
                                    Types d'analyse
                                </h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-danger" onclick="detectInconsistencies('all')">
                                        <i class="bi bi-shield-exclamation me-2"></i>
                                        Analyse complète
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" onclick="detectInconsistencies('missing')">
                                        <i class="bi bi-question-circle me-2"></i>
                                        Données manquantes
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="detectInconsistencies('aberrant')">
                                        <i class="bi bi-graph-up-arrow me-2"></i>
                                        Valeurs aberrantes
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="detectInconsistencies('duplicates')">
                                        <i class="bi bi-files me-2"></i>
                                        Doublons
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary mb-3">
                                    <i class="bi bi-bar-chart me-2"></i>
                                    Statistiques actuelles
                                </h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Concurrents</div>
                                            <div class="h5 mb-0" id="stats-competitors">-</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center p-2 bg-light rounded">
                                            <div class="small text-muted">Vidéos</div>
                                            <div class="h5 mb-0" id="stats-videos">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="inconsistencies-results" class="mt-4" style="display: none;">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        Incohérences détectées
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="inconsistencies-details">
                                        <!-- Résultats seront peuplés ici -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progression -->
                        <div id="inconsistencies-progress" class="mt-4" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                                     role="progressbar" style="width: 0%" id="inconsistencies-progress-bar"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted" id="inconsistencies-progress-text">Initialisation...</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 🚨 NOUVELLE SECTION : Vérification d'intégrité -->
                <div class="card settings-card mb-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check me-2"></i>
                            🛡️ Vérification d'intégrité CRITIQUE (Supervision humaine)
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning alert-custom" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Protection supervision humaine :</strong> Vérifiez que toutes les classifications humaines sont protégées et qu'aucune fonction ne peut les écraser.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="mb-3">🔍 Vérification d'intégrité</h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-info" onclick="verifyIntegrityAdvanced()">
                                        <i class="bi bi-shield-check me-2"></i>
                                        Vérifier l'intégrité complète
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="checkFunctionsSafety()">
                                        <i class="bi bi-gear me-2"></i>
                                        Vérifier la sécurité des fonctions
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="mb-3">🛠️ Réparation</h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-success" onclick="fixClassificationTracking()">
                                        <i class="bi bi-wrench me-2"></i>
                                        Réparer le tracking manquant
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="updateDatabaseSchemaWithHumanProtection()">
                                        <i class="bi bi-database-gear me-2"></i>
                                        Mettre à jour le schéma (Protection humaine)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Zone de résultats -->
                        <div id="integrityResults" class="mt-4" style="display: none;">
                            <h6>📊 Résultats de vérification</h6>
                            <div id="integrityReport"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkCompetitorStatus();
        loadInconsistencyStats();
        loadPropagationStatuses();
    });

    // Load propagation statuses from database
    async function loadPropagationStatuses() {
        try {
            // Load propagation patterns status
            const propagationResponse = await fetch('/api/get-action-status/last_propagation');
            const propagationData = await propagationResponse.json();
            updateStatusCard('propagation-status', propagationData, 'Propagation Patterns');
            
            // Load reclassification status
            const reclassificationResponse = await fetch('/api/get-action-status/last_reclassification');
            const reclassificationData = await reclassificationResponse.json();
            updateStatusCard('reclassification-status', reclassificationData, 'Re-classification');
            
            // Load AI classification status
            const aiResponse = await fetch('/api/get-action-status/last_playlist_classification');
            const aiData = await aiResponse.json();
            updateStatusCard('ai-classification-status', aiData, 'Classification IA');
            
        } catch (error) {
            console.error('Error loading propagation statuses:', error);
            updateStatusCard('propagation-status', null, 'Propagation Patterns');
            updateStatusCard('reclassification-status', null, 'Re-classification');
            updateStatusCard('ai-classification-status', null, 'Classification IA');
        }
    }

    function updateStatusCard(elementId, data, title) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (data && data.success && data.updated_at) {
            const date = new Date(data.updated_at);
            const formattedDate = date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            const formattedTime = date.toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let statusBadge = 'success';
            let statusText = 'Terminé';
            
            if (data.error) {
                statusBadge = 'danger';
                statusText = 'Erreur';
            } else if (data.message && data.message.includes('en cours')) {
                statusBadge = 'warning';
                statusText = 'En cours';
            }
            
            element.innerHTML = `
                <div class="mb-2">
                    <span class="badge bg-${statusBadge}">${statusText}</span>
                </div>
                <div class="small text-muted mb-1">
                    <i class="bi bi-calendar me-1"></i>
                    ${formattedDate}
                </div>
                <div class="small text-muted mb-2">
                    <i class="bi bi-clock me-1"></i>
                    ${formattedTime}
                </div>
                ${data.message ? `<div class="small text-muted">${data.message}</div>` : ''}
            `;
        } else {
            element.innerHTML = `
                <div class="mb-2">
                    <span class="badge bg-secondary">Jamais exécuté</span>
                </div>
                <div class="small text-muted">
                    Aucun log trouvé en base
                </div>
            `;
        }
    }

    // [Include all the JavaScript functions from settings.html for propagation, sync, and inconsistency detection]
    // This would include: propagatePatterns, reclassifyAllVideos, updateClassificationLogic, resetPropagation, 
    // checkCompetitorStatus, syncCompetitorsToDb, detectInconsistencies, etc.
    
    // Placeholder for now - these functions would be copied from settings.html
    function propagatePatterns() {
        // showAlert('Propagation function will be implemented here', 'info');
        console.log('Propagation function called');
    }
    
    function reclassifyAllVideos() {
        // showAlert('Reclassification function will be implemented here', 'info');
        console.log('Reclassification function called');
    }
    
    function updateClassificationLogic() {
        // showAlert('Update logic function will be implemented here', 'info');
        console.log('Update logic function called');
    }
    
    function resetPropagation() {
        // showAlert('Reset function will be implemented here', 'info');
        console.log('Reset function called');
    }
    
    function checkCompetitorStatus() {
        // showAlert('Check status function will be implemented here', 'info');
        // Function disabled to avoid unwanted notifications
    }
    
    function syncCompetitorsToDb() {
        // showAlert('Sync function will be implemented here', 'info');
        console.log('Sync function called');
    }
    
    function detectInconsistencies(type) {
        // showAlert('Inconsistency detection function will be implemented here', 'info');
        console.log('Inconsistency detection function called with type:', type);
    }
    
    function loadInconsistencyStats() {
        // Load basic stats
        document.getElementById('stats-competitors').textContent = '0';
        document.getElementById('stats-videos').textContent = '0';
    }

    // === CLASSIFICATION FUNCTIONS ===
    
    async function classifyAllUnclassified() {
        try {
            const button = document.querySelector('button[onclick="classifyAllUnclassified()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-robot spinner-border spinner-border-sm me-2"></i> Classification en cours...';
            
            const response = await fetch('/api/classify-all-unclassified', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showClassificationResults(result);
                showAlert(result.message, 'success');
                checkClassificationStatus(); // Refresh stats
            } else {
                showAlert('Erreur lors de la classification: ' + result.error, 'danger');
            }
            
            button.disabled = false;
            button.innerHTML = originalText;
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Erreur lors de la classification', 'danger');
            const button = document.querySelector('button[onclick="classifyAllUnclassified()"]');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-robot me-2"></i> Classifier toutes les vidéos non classifiées';
            }
        }
    }

    async function runGlobalAiClassification() {
        try {
            const button = document.querySelector('button[onclick="runGlobalAiClassification()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-collection-play spinner-border spinner-border-sm me-2"></i> Classification IA globale...';
            
            const response = await fetch('/api/global-ai-classification', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showClassificationResults(result);
                showAlert('Classification IA terminée: ' + result.playlists_classified + ' playlists et ' + result.videos_classified + ' vidéos classifiées', 'success');
                checkClassificationStatus(); // Refresh stats
            } else {
                showAlert('Erreur lors de la classification IA: ' + result.error, 'danger');
            }
            
            button.disabled = false;
            button.innerHTML = originalText;
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Erreur lors de la classification IA', 'danger');
            const button = document.querySelector('button[onclick="runGlobalAiClassification()"]');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-collection-play me-2"></i> Classification IA globale (Playlists + Vidéos)';
            }
        }
    }

    async function updateDatabaseSchemaWithHumanProtection() {
        try {
            const button = document.querySelector('button[onclick="updateDatabaseSchemaWithHumanProtection()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-shield-check spinner-border spinner-border-sm me-2"></i> Mise à jour BDD...';
            
            const response = await fetch('/api/update-database-schema-with-human-protection', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('🛡️ ' + result.message, 'success');
                checkClassificationStatus(); // Refresh stats
            } else {
                showAlert('❌ Erreur lors de la mise à jour: ' + result.error, 'danger');
            }
            
            button.disabled = false;
            button.innerHTML = originalText;
            
        } catch (error) {
            console.error('Error:', error);
            showAlert('Erreur lors de la mise à jour du schéma', 'danger');
            const button = document.querySelector('button[onclick="updateDatabaseSchemaWithHumanProtection()"]');
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-shield-check me-2"></i> Mise à jour BDD - Protection supervision humaine';
            }
        }
    }

    async function checkClassificationStatus() {
        try {
            // Cette fonction devrait interroger une API pour obtenir les statistiques
            // Pour l'instant, on simule avec des valeurs par défaut
            document.getElementById('classified-videos').textContent = '?';
            document.getElementById('unclassified-videos').textContent = '?';
            
            showAlert('Vérification du statut de classification (à implémenter)', 'info');
            
        } catch (error) {
            console.error('Error checking classification status:', error);
            document.getElementById('classified-videos').textContent = 'Erreur';
            document.getElementById('unclassified-videos').textContent = 'Erreur';
        }
    }

    function showClassificationResults(result) {
        const resultsDiv = document.getElementById('classification-results');
        const detailsDiv = document.getElementById('classification-details');
        
        let html = '<div class="row g-3">';
        
        if (result.total_classified !== undefined) {
            html += `
                <div class="col-md-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-success mb-0">${result.total_classified}</div>
                        <div class="small text-muted">Vidéos classifiées</div>
                    </div>
                </div>
            `;
        }
        
        if (result.classified_competitors && result.classified_competitors.length > 0) {
            html += `
                <div class="col-md-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-primary mb-0">${result.classified_competitors.length}</div>
                        <div class="small text-muted">Concurrents traités</div>
                    </div>
                </div>
            `;
        }
        
        if (result.playlists_classified !== undefined) {
            html += `
                <div class="col-md-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-info mb-0">${result.playlists_classified}</div>
                        <div class="small text-muted">Playlists classifiées</div>
                    </div>
                </div>
            `;
        }
        
        if (result.videos_classified !== undefined) {
            html += `
                <div class="col-md-6">
                    <div class="text-center p-3 bg-light rounded">
                        <div class="h4 text-warning mb-0">${result.videos_classified}</div>
                        <div class="small text-muted">Vidéos classifiées</div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        
        if (result.classified_competitors && result.classified_competitors.length > 0) {
            html += '<div class="mt-3"><h6>Détails par concurrent:</h6><ul class="list-group">';
            result.classified_competitors.forEach(comp => {
                html += `<li class="list-group-item d-flex justify-content-between">
                    <span>${comp.name}</span>
                    <span class="badge bg-success">${comp.videos_classified} vidéos</span>
                </li>`;
            });
            html += '</ul></div>';
        }
        
        detailsDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
    }

    function showAlert(message, type) {
        // Simple alert function - you might want to integrate with your existing alert system
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // === NOUVELLES FONCTIONS D'INTÉGRITÉ ===
    
    async function verifyIntegrityAdvanced() {
        try {
            const button = document.querySelector('button[onclick="verifyIntegrityAdvanced()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-shield-check spinner-border spinner-border-sm me-2"></i> Vérification...';
            
            const response = await fetch('/api/verify-classification-integrity-advanced', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayIntegrityReport(result.report);
                showAlert('Vérification d\'intégrité terminée!', 'success');
            } else {
                showAlert('Erreur lors de la vérification: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Erreur lors de la vérification:', error);
            showAlert('Erreur lors de la vérification: ' + error.message, 'danger');
        } finally {
            const button = document.querySelector('button[onclick="verifyIntegrityAdvanced()"]');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-shield-check me-2"></i> Vérifier l\'intégrité complète';
        }
    }
    
    async function checkFunctionsSafety() {
        try {
            const button = document.querySelector('button[onclick="checkFunctionsSafety()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-gear spinner-border spinner-border-sm me-2"></i> Vérification...';
            
            const response = await fetch('/api/debug-functions-safety-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                displaySafetyReport(result.safety_report);
                showAlert('Vérification de sécurité terminée!', 'success');
            } else {
                showAlert('Erreur lors de la vérification: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Erreur lors de la vérification:', error);
            showAlert('Erreur lors de la vérification: ' + error.message, 'danger');
        } finally {
            const button = document.querySelector('button[onclick="checkFunctionsSafety()"]');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-gear me-2"></i> Vérifier la sécurité des fonctions';
        }
    }
    
    async function fixClassificationTracking() {
        try {
            const button = document.querySelector('button[onclick="fixClassificationTracking()"]');
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="bi bi-wrench spinner-border spinner-border-sm me-2"></i> Réparation...';
            
            const response = await fetch('/api/fix-classification-tracking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Réparation terminée: ' + result.message, 'success');
                
                // Afficher les détails des corrections
                if (result.fixes_applied && result.fixes_applied.length > 0) {
                    const fixesHtml = result.fixes_applied.map(fix => `<li>${fix}</li>`).join('');
                    showAlert(`<strong>Corrections appliquées:</strong><ul>${fixesHtml}</ul>`, 'info');
                }
            } else {
                showAlert('Erreur lors de la réparation: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Erreur lors de la réparation:', error);
            showAlert('Erreur lors de la réparation: ' + error.message, 'danger');
        } finally {
            const button = document.querySelector('button[onclick="fixClassificationTracking()"]');
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-wrench me-2"></i> Réparer le tracking manquant';
        }
    }
    
    function displayIntegrityReport(report) {
        const resultsDiv = document.getElementById('integrityResults');
        const reportDiv = document.getElementById('integrityReport');
        
        let html = `
            <div class="card">
                <div class="card-header bg-${report.status === 'excellent' ? 'success' : report.status === 'critical' ? 'danger' : 'warning'} text-white">
                    <h6 class="mb-0">${report.summary}</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>📊 Statistiques</h6>
                            <p><strong>Vidéos:</strong> ${report.stats.videos.total_classified} classifiées</p>
                            <p><strong>Protégées (Humain):</strong> ${report.stats.videos.human_protected}</p>
                            <p><strong>Classifiées IA:</strong> ${report.stats.videos.ai_classified}</p>
                            <p><strong>Héritées playlist:</strong> ${report.stats.videos.playlist_inherited}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>📋 Playlists</h6>
                            <p><strong>Total:</strong> ${report.stats.playlists.total_classified}</p>
                            <p><strong>Protégées (Humain):</strong> ${report.stats.playlists.human_protected}</p>
                            <p><strong>Classifiées IA:</strong> ${report.stats.playlists.ai_classified}</p>
                        </div>
                    </div>
        `;
        
        if (report.issues && report.issues.length > 0) {
            html += '<h6>⚠️ Problèmes détectés</h6><ul>';
            report.issues.forEach(issue => {
                html += `<li><span class="badge bg-${issue.severity === 'error' ? 'danger' : 'warning'}">${issue.severity}</span> ${issue.description}</li>`;
            });
            html += '</ul>';
        }
        
        if (report.recommendations && report.recommendations.length > 0) {
            html += '<h6>💡 Recommandations</h6><ul>';
            report.recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div></div>';
        
        reportDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
    }
    
    function displaySafetyReport(report) {
        const resultsDiv = document.getElementById('integrityResults');
        const reportDiv = document.getElementById('integrityReport');
        
        let html = `
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">${report.summary}</h6>
                </div>
                <div class="card-body">
                    <h6>🛡️ Fonctions sécurisées (${report.safe_functions.length})</h6>
                    <div class="row">
        `;
        
        report.safe_functions.forEach(func => {
            html += `
                <div class="col-md-6 mb-2">
                    <div class="card border-success">
                        <div class="card-body p-2">
                            <small><strong>${func.function}</strong></small><br>
                            <small class="text-muted">${func.protection}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        if (report.protected_logic && report.protected_logic.length > 0) {
            html += '<h6>🔒 Mécanismes de protection</h6><ul>';
            report.protected_logic.forEach(logic => {
                html += `<li>${logic}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div></div>';
        
        reportDiv.innerHTML = html;
        resultsDiv.style.display = 'block';
    }
</script>
{% endblock %} 