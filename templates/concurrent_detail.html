{% extends "base.html" %}

{% block title %}Dashboard {{ competitor.name or 'Concurrent' }} - YT Analyzer{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border-radius: 15px;
        transition: transform 0.2s;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }
    .performance-matrix {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }
    .category-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 20px;
    }
    .hero-badge { background: #ff6b6b; color: white; }
    .hub-badge { background: #4ecdc4; color: white; }
    .help-badge { background: #45b7d1; color: white; }
    .paid-badge { background: #f39c12; color: white; }
    .organic-badge { background: #27ae60; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
<div class="container-fluid">
    <!-- Header avec titre et informations de base -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">
                        <i class="bi bi-youtube text-danger me-3"></i>
                        {{ competitor.name or 'Concurrent' }}
                    </h1>
                    <p class="text-muted">Analyse d√©taill√©e ‚Ä¢ {{ stats.total_videos or 0 }} vid√©os</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-danger me-2" 
                            onclick="confirmDeleteFromDetail('{{ request.view_args.competitor_id }}', '{{ competitor.name or 'Ce concurrent' }}')"
                            title="Supprimer ce concurrent">
                        <i class="bi bi-trash me-1"></i>
                        Supprimer
                    </button>
                    <a href="/concurrents" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Retour
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- M√©triques principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.total_videos or 0 }}</h3>
                    <p class="mb-0">Vid√©os analys√©es</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ competitor.total_views or "N/A" }}</h3>
                    <p class="mb-0">Vues totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-warning text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.paid_percentage or 0 }}%</h3>
                    <p class="mb-0">Contenu pay√©</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.organic_percentage or 0 }}%</h3>
                    <p class="mb-0">Contenu organique</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Matrice de performance (style Airbnb) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card performance-matrix">
                <div class="card-body">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Matrice de Performance : HUB ‚Ä¢ HERO ‚Ä¢ HELP vs Organic ‚Ä¢ Paid
                    </h4>
                    
                    <div class="row text-center">
                        <div class="col-md-2 mb-3">
                            <h6>Seuil configur√©</h6>
                            <p class="mb-0">{{ stats.paid_threshold or 10000 }}+ vues = Paid</p>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-warning">üî• HERO</h6>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-info">üè† HUB</h6>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-primary">üÜò HELP</h6>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Ligne Organic -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <h6 class="text-success">üå± Organic</h6>
                                <small>(‚â§{{ stats.paid_threshold or 10000 }} vues)</small>
                            </div>
                        </div>
                        
                        {% for category in ['hero', 'hub', 'help'] %}
                        <div class="col-md-2 mb-3">
                            <div class="bg-light text-dark p-3 rounded">
                                <h5>{{ (stats.performance_matrix[category].organic_median / 1000)|round(1) }}k vues</h5>
                                <small>({{ stats.performance_matrix[category].organic_count }} vid√©os)</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="row">
                        <!-- Ligne Paid -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <h6 class="text-warning">üí∞ Paid</h6>
                                <small>(>{{ stats.paid_threshold or 10000 }} vues)</small>
                            </div>
                        </div>
                        
                        {% for category in ['hero', 'hub', 'help'] %}
                        <div class="col-md-2 mb-3">
                            <div class="bg-light text-dark p-3 rounded">
                                <h5>{{ (stats.performance_matrix[category].paid_median / 1000)|round(1) }}k vues</h5>
                                <small>({{ stats.performance_matrix[category].paid_count }} vid√©os)</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart me-2"></i>Distribution HUB ‚Ä¢ HERO ‚Ä¢ HELP</h5>
                </div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="categoryChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart me-2"></i>Organic vs Paid</h5>
                </div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="distributionChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglets avec d√©tails -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="hero-tab" data-bs-toggle="tab" data-bs-target="#hero" type="button">
                        üî• HERO ({{ stats.hero_count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="hub-tab" data-bs-toggle="tab" data-bs-target="#hub" type="button">
                        üè† HUB ({{ stats.hub_count }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button">
                        üÜò HELP ({{ stats.help_count }})
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="analysisTabContent">
                {% for category in ['hero', 'hub', 'help'] %}
                <div class="tab-pane fade {% if category == 'hero' %}show active{% endif %}" id="{{ category }}">
                    <div class="card border-0">
                        <div class="card-body">
                            {% if videos_by_category[category] %}
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Titre</th>
                                            <th>Vues</th>
                                            <th>Likes</th>
                                            <th>Type</th>
                                            <th>Score</th>
                                            <th>Tag</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for video in videos_by_category[category][:10] %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div>
                                                        {{ video.title[:60] }}{% if video.title|length > 60 %}...{% endif %}
                                                        <br>
                                                        <small class="text-muted">Confiance: {{ video.confidence }}%</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ video.views }}</td>
                                            <td>{{ video.likes }}</td>
                                            <td>
                                                <span class="badge {{ 'paid-badge' if video.distribution_type == 'paid' else 'organic-badge' }}">
                                                    {{ video.distribution_type|title }}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ video.performance_score }}/10</span>
                                            </td>
                                            <td>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                        <i class="bi bi-tag"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video.url }}', '{{ video.title }}', 'help')">üÜò HELP</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video.url }}', '{{ video.title }}', 'hero')">üî• HERO</a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video.url }}', '{{ video.title }}', 'hub')">üè† HUB</a></li>
                                                    </ul>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <h5 class="text-muted mt-3">Aucune vid√©o {{ category.upper() }}</h5>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Wait for Chart.js to load before creating charts
document.addEventListener('DOMContentLoaded', function() {
    // Graphique en camembert pour les cat√©gories
    const ctx1 = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: ['üî• HERO', 'üè† HUB', 'üÜò HELP'],
            datasets: [{
                data: [{{ stats.hero_count or 0 }}, {{ stats.hub_count or 0 }}, {{ stats.help_count or 0 }}],
                backgroundColor: [
                    '#ff6b6b',  // Rouge pour HERO
                    '#4ecdc4',  // Turquoise pour HUB  
                    '#45b7d1'   // Bleu pour HELP
                ],
                borderWidth: 3,
                borderColor: '#ffffff',
                hoverBorderWidth: 4,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} vid√©os (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                duration: 2000
            }
        }
    });

    // Graphique en barres pour Organic vs Paid
    const ctx2 = document.getElementById('distributionChart').getContext('2d');
    new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: ['üå± Organic', 'üí∞ Paid'],
            datasets: [{
                label: 'Nombre de vid√©os',
                data: [{{ stats.organic_count or 0 }}, {{ stats.paid_count or 0 }}],
                backgroundColor: [
                    'rgba(39, 174, 96, 0.8)',   // Vert pour Organic
                    'rgba(243, 156, 18, 0.8)'   // Orange pour Paid
                ],
                borderColor: [
                    'rgba(39, 174, 96, 1)',
                    'rgba(243, 156, 18, 1)'
                ],
                borderWidth: 2,
                borderRadius: 12,
                borderSkipped: false,
                hoverBackgroundColor: [
                    'rgba(39, 174, 96, 1)',
                    'rgba(243, 156, 18, 1)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                            return `${context.parsed.y} vid√©os (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    },
                    ticks: {
                        font: {
                            weight: 'bold'
                        }
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutBounce'
            }
        }
    });
});

// Fonction de tagging des vid√©os
async function tagVideo(videoUrl, videoTitle, category) {
    const competitorId = window.location.pathname.split('/').pop();
    
    try {
        const response = await fetch('/api/tag-video', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                video_url: videoUrl,
                title: videoTitle,
                category: category,
                competitor_id: competitorId
            })
        });
        
        const result = await response.json();
        if (result.success) {
            // Afficher un message de succ√®s
            showAlert(result.message, 'success');
            // Recharger la page apr√®s 1 seconde pour voir les changements
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showAlert('Erreur lors du tagging', 'danger');
        }
    } catch (error) {
        console.error('Erreur:', error);
        showAlert('Erreur lors du tagging', 'danger');
    }
}

function showAlert(message, type) {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);';
    alert.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    // Auto-dismiss apr√®s 3 secondes
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 3000);
}

// Fonction de suppression depuis la page de d√©tail
function confirmDeleteFromDetail(competitorId, competitorName) {
    if (confirm(`√ätes-vous s√ªr de vouloir supprimer le concurrent "${competitorName}" ?\n\nCette action est irr√©versible et supprimera toutes les donn√©es associ√©es.`)) {
        deleteCompetitorFromDetail(competitorId, competitorName);
    }
}

function deleteCompetitorFromDetail(competitorId, competitorName) {
    fetch('/api/delete-competitor', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            competitor_id: competitorId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Concurrent "${competitorName}" supprim√© avec succ√®s !`, 'success');
            // Rediriger vers la page des concurrents apr√®s 1.5 secondes
            setTimeout(() => {
                window.location.href = '/concurrents';
            }, 1500);
        } else {
            showAlert(`Erreur lors de la suppression : ${data.error || 'Erreur inconnue'}`, 'danger');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showAlert('Une erreur est survenue lors de la suppression.', 'danger');
    });
}
</script>
{% endblock %} 