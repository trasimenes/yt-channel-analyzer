{% extends "sneat_base.html" %}

{% block title %}Dashboard {{ competitor.name or 'Concurrent' }} - YT Analyzer{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        border-radius: 15px;
        transition: transform 0.2s;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
    }
    .performance-matrix {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
    }
    .category-badge {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 20px;
    }
    .hero-badge { background: #ff6b6b; color: white; }
    .hub-badge { background: #4ecdc4; color: white; }
    .help-badge { background: #45b7d1; color: white; }
    .paid-badge { background: #f39c12; color: white; }
    .organic-badge { background: #27ae60; color: white; }
    
    /* Styles spécifiques aux playlists */
    .playlist-section {
        border-radius: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .playlist-card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .playlist-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    .section-separator {
        height: 4px;
        background: linear-gradient(45deg, #667eea, #764ba2);
        border-radius: 2px;
        margin: 3rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
<div class="container-fluid">
    <!-- Header avec titre et informations de base -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5">
                        <i class="bi bi-youtube text-danger me-3"></i>
                        {{ competitor.name or 'Concurrent' }}
                    </h1>
                    <p class="text-muted">Detailed Analysis • {{ stats.total_videos or 0 }} videos</p>
                </div>
                <div class="text-end">
                    <button class="btn btn-outline-danger me-2" 
                            onclick="confirmDeleteFromDetail('{{ request.view_args.competitor_id }}', '{{ competitor.name or 'Ce concurrent' }}')"
                            title="Supprimer ce concurrent">
                        <i class="bi bi-trash me-1"></i>
                        Supprimer
                    </button>
                    <a href="/concurrents" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>
                        Retour
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Métriques principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card metric-card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.total_videos or 0 }}</h3>
                    <p class="mb-0">Videos Analyzed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.total_views|format_number if stats.total_views else "N/A" }}</h3>
                    <p class="mb-0">Total Views</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-warning text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.paid_percentage or 0 }}%</h3>
                    <p class="mb-0">Paid Content</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card metric-card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ stats.organic_percentage or 0 }}%</h3>
                    <p class="mb-0">Organic Content</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section de tagging et métadonnées -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-tags me-2"></i>Tags et Classification</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="competitorSector" class="form-label">Secteur</label>
                                <select class="form-select" id="competitorSector">
                                    <option value="hospitality">Hospitalité</option>
                                    <option value="tourism">Tourisme</option>
                                    <option value="food">Restauration</option>
                                    <option value="retail">Commerce</option>
                                    <option value="service">Service</option>
                                    <option value="other">Autre</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="competitorRegion" class="form-label">Région personnalisée</label>
                                <input type="text" class="form-control" id="competitorRegion" placeholder="Ex: Benelux, Europe du Nord">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="competitorTags" class="form-label">Tags personnalisés</label>
                                <input type="text" class="form-control" id="competitorTags" placeholder="Ex: luxury, family, budget">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="competitorActive" class="form-label">Statut</label>
                                <select class="form-select" id="competitorActive">
                                    <option value="1">Actif</option>
                                    <option value="0">Inactif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label for="competitorNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="competitorNotes" rows="2" placeholder="Notes libres sur ce concurrent..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="saveCompetitorTags()">
                                        <i class="bi bi-save me-2"></i>
                                        Sauvegarder
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone de résultat -->
                    <div id="taggingResult" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <div id="taggingMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section d'upload CSV -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-file-earmark-spreadsheet me-2"></i>Import Subscriber Data (CSV)</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <form id="csvUploadForm" enctype="multipart/form-data">
                                <div class="mb-3">
                                    <label for="csvFile" class="form-label">CSV file with subscriber statistics</label>
                                    <input type="file" class="form-control" id="csvFile" name="csvFile" accept=".csv" required>
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Expected format: "Context" and "Text" columns with dates and subscriber numbers
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-upload me-2"></i>
                                    Import Data
                                </button>
                            </form>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light p-3 rounded">
                                <h6><i class="bi bi-info-circle me-2"></i>CSV Format</h6>
                                <small class="text-muted">
                                    The file must contain:
                                    <ul class="mt-2 mb-0">
                                        <li>Colonne "Context" (peut être vide)</li>
                                        <li>"Text" column with dates and subscriber numbers</li>
                                        <li>Format : "Date\nSubscribers\n1,234"</li>
                                    </ul>
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Zone de résultat -->
                    <div id="csvUploadResult" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <div id="csvUploadMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphique d'évolution des abonnés -->
    <div class="row mb-4" id="subscriberChartSection">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-graph-up me-2"></i>Subscriber Growth</h5>
                    <div id="subscriberStats" class="text-end">
                        {% if subscriber_data and subscriber_data.has_data %}
                        <span class="badge bg-primary me-2">{{ subscriber_data.stats.total_entries }} months of data</span>
                        <span class="badge bg-success">{{ (subscriber_data.stats.total_growth / 1000)|round(0)|int }}K+ subscribers</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body" style="height: 440px;">
                    <div style="position: relative; height: 440px;">
                        <canvas id="subscriberChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= GRAPHIQUES ANALYTIQUES ======= -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up me-2"></i>Analytics Dashboard</h5>
                </div>
                <div class="card-body">
                    <!-- Métriques principales -->
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-primary">
                                <div class="card-body">
                                    <i class="bi bi-play-circle text-primary" style="font-size: 2rem;"></i>
                                    <h5 class="card-title mt-2">{{ total_videos }}</h5>
                                    <p class="card-text text-muted">Total Videos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-success">
                                <div class="card-body">
                                    <i class="bi bi-eye text-success" style="font-size: 2rem;"></i>
                                    <h5 class="card-title mt-2">{{ (stats.total_views / 1000000)|round(1) if stats.total_views else 0 }}M</h5>
                                    <p class="card-text text-muted">Total Views</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-warning">
                                <div class="card-body">
                                    <i class="bi bi-collection-play text-warning" style="font-size: 2rem;"></i>
                                    <h5 class="card-title mt-2">{{ playlists|length if playlists else 0 }}</h5>
                                    <p class="card-text text-muted">Playlists</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card text-center border-info">
                                <div class="card-body">
                                    <i class="bi bi-people text-info" style="font-size: 2rem;"></i>
                                    <h5 class="card-title mt-2" id="subscribersCount">
                                        {% if subscriber_data and subscriber_data.has_data %}
                                            {{ (subscriber_data.stats.last_count / 1000)|round(1) }}K
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </h5>
                                    <p class="card-text text-muted">Subscribers</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ======= MODULE PLAYLISTS (SECTION DÉDIÉE) ======= -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card playlist-section">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="bi bi-collection-play me-2"></i>
                            {{ competitor.name }} Playlists
                            <span class="badge bg-light text-dark ms-2">{{ playlists|length if playlists else 0 }}</span>
                        </h4>
                        <div>
                            <button class="btn btn-primary btn-sm me-2" onclick="window.location.href='/competitor/{{ competitor.id }}/playlists/classify'">
                                <i class="bi bi-lightning me-1"></i>
                                Advanced Classification
                            </button>
                            <button class="btn btn-light btn-sm me-2" onclick="refreshPlaylists()" title="⚠️ Utilise l'API YouTube (quota limité)">
                                <i class="bi bi-arrow-repeat me-1"></i>
                                Refresh
                                <small class="text-muted d-block" style="font-size: 0.7em;">⚠️ API YouTube</small>
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="aiClassifyPlaylists()" title="⚠️ Classification automatique par IA">
                                <i class="bi bi-robot me-1"></i>
                                AI Auto-Classify
                                <small class="text-muted d-block" style="font-size: 0.7em;">🤖 AI</small>
                            </button>
                        </div>
                    </div>
                    {% if last_playlist_classification %}
                    <div class="mb-3 text-end">
                        <small class="text-light">Dernière classification IA : {{ last_playlist_classification }}</small>
                    </div>
                    {% endif %}
                    {% if playlists %}
                    {% set sorted_playlists = playlists | sort(attribute='video_count', reverse=True) %}
                    <ul class="nav nav-tabs mb-3" id="playlistTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-white" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab">All</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white" id="playlist-hero-tab" data-bs-toggle="tab" data-bs-target="#playlist-hero" type="button" role="tab">🔥 HERO</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white" id="playlist-hub-tab" data-bs-toggle="tab" data-bs-target="#playlist-hub" type="button" role="tab">🏠 HUB</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white" id="playlist-help-tab" data-bs-toggle="tab" data-bs-target="#playlist-help" type="button" role="tab">🆘 HELP</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-white" id="uncat-tab" data-bs-toggle="tab" data-bs-target="#uncat" type="button" role="tab">Uncategorized</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="playlistTabsContent">
                        <div class="tab-pane fade show active" id="all" role="tabpanel">
                            <div class="row">
                                {% for playlist in sorted_playlists %}
                                    {% include 'components/playlist_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="playlist-hero" role="tabpanel">
                            <div class="row">
                                {% for playlist in sorted_playlists if playlist.category == 'hero' %}
                                    {% include 'components/playlist_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="playlist-hub" role="tabpanel">
                            <div class="row">
                                {% for playlist in sorted_playlists if playlist.category == 'hub' %}
                                    {% include 'components/playlist_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="playlist-help" role="tabpanel">
                            <div class="row">
                                {% for playlist in sorted_playlists if playlist.category == 'help' %}
                                    {% include 'components/playlist_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                        <div class="tab-pane fade" id="uncat" role="tabpanel">
                            <div class="row">
                                {% for playlist in sorted_playlists if not playlist.category %}
                                    {% include 'components/playlist_card.html' %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-collection-play text-white" style="font-size: 3rem; opacity: 0.7;"></i>
                        <h5 class="text-white mt-3">No playlists found</h5>
                        <p class="text-white-50">
                            Click "Refresh" to retrieve playlists from this channel.
                        </p>
                        <button class="btn btn-light" onclick="refreshPlaylists()">
                            <i class="bi bi-arrow-repeat me-2"></i>
                            Retrieve playlists
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Séparateur visuel -->
    <div class="section-separator"></div>

    <!-- ======= SECTION YOUTUBE SHORTS ======= -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" style="background: linear-gradient(135deg, #FF6B6B 0%, #FF8E8E 100%); color: white;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">
                            <i class="bi bi-play-circle me-2"></i>
                            YouTube Shorts Analysis
                            <span class="badge bg-light text-dark ms-2" id="shortsCount">...</span>
                        </h4>
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-check-circle me-1"></i>
                            Data Updated
                        </span>
                    </div>
                    
                    <!-- Métriques Shorts - Disposition horizontale en ligne -->
                    <div class="d-flex flex-wrap gap-3 mb-4" id="shortsMetrics">
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                <h5 class="mb-1">{{ shorts_data.shorts_percentage or 0 }}%</h5>
                                <small>Shorts Ratio</small>
                            </div>
                        </div>
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                <h5 class="mb-1">{{ (shorts_data.avg_views_shorts / 1000)|round(1) if shorts_data.avg_views_shorts else 0 }}k</h5>
                                <small>Avg. Shorts Views</small>
                            </div>
                        </div>
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                <h5 class="mb-1">{{ (shorts_data.avg_views_regular / 1000)|round(1) if shorts_data.avg_views_regular else 0 }}k</h5>
                                <small>Avg. Video Views</small>
                            </div>
                        </div>
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                {% if shorts_data.avg_views_regular and shorts_data.avg_views_shorts %}
                                    {% set ratio = shorts_data.avg_views_shorts / shorts_data.avg_views_regular %}
                                    {% if ratio > 1.5 %}
                                        <h5 class="mb-1 text-success">+{{ ((ratio - 1) * 100)|round(0) }}%</h5>
                                    {% elif ratio < 0.5 %}
                                        <h5 class="mb-1 text-danger">-{{ ((1 - ratio) * 100)|round(0) }}%</h5>
                                    {% else %}
                                        <h5 class="mb-1 text-warning">{{ ((ratio - 1) * 100)|round(0) }}%</h5>
                                    {% endif %}
                                {% else %}
                                    <h5 class="mb-1">N/A</h5>
                                {% endif %}
                                <small>Relative Performance</small>
                            </div>
                        </div>
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                <h5 class="mb-1">{{ shorts_data.shorts_count or 0 }}</h5>
                                <small>Total Shorts</small>
                            </div>
                        </div>
                        <div class="flex-fill">
                            <div class="bg-light text-dark p-2 rounded text-center">
                                <h5 class="mb-1">{{ ((shorts_data.shorts_count or 0) / (stats.total_videos or 1) * 100)|round(1) }}%</h5>
                                <small>% of Content</small>
                            </div>
                        </div>
                    </div>



                    <!-- Recommandations -->
                    <div class="row">
                        <div class="col-12">
                            <div class="bg-light text-dark p-3 rounded">
                                <h6><i class="bi bi-pie-chart me-2"></i>Content Distribution</h6>
                                <div class="d-flex justify-content-center">
                                    <canvas id="shortsChart" width="300" height="150"></canvas>
                                </div>
                                <div class="row mt-3 text-center">
                                    <div class="col-6">
                                        <div class="p-2 rounded text-white" style="background-color: #FF6B6B;">
                                            <strong>{{ shorts_data.shorts_count or 0 }}</strong>
                                            <br><small>Shorts</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="p-2 rounded text-white" style="background-color: #4ECDC4;">
                                            <strong>{{ (stats.total_videos or 0) - (shorts_data.shorts_count or 0) }}</strong>
                                            <br><small>Long Videos</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading state (disabled) -->
                    <div id="shortsLoading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2">Analyzing Shorts...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Séparateur visuel -->
    <div class="section-separator"></div>

    <!-- Matrice de performance (style Airbnb) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card performance-matrix">
                <div class="card-body">
                    <h4 class="text-center mb-4">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        Matrice de Performance : HUB • HERO • HELP vs Organic • Paid
                    </h4>
                    
                    <div class="row text-center">
                        <div class="col-md-2 mb-3">
                            <h6>Seuil configuré</h6>
                            <p class="mb-0">{{ stats.paid_threshold or 10000 }}+ views = Paid</p>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-warning">🔥 HERO</h6>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-info">🏠 HUB</h6>
                        </div>
                        <div class="col-md-2 mb-3">
                            <h6 class="text-primary">🆘 HELP</h6>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Ligne Organic -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <h6 class="text-success">🌱 Organic</h6>
                                <small>(≤{{ stats.paid_threshold or 10000 }} views)</small>
                            </div>
                        </div>
                        
                        {% for category in ['hero', 'hub', 'help'] %}
                        <div class="col-md-2 mb-3">
                            <div class="bg-light text-dark p-3 rounded">
                                <h5>{{ (stats.performance_matrix[category].organic_median / 1000)|round(1) }}k views</h5>
                                <small>({{ stats.performance_matrix[category].organic_count }} videos)</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="row">
                        <!-- Ligne Paid -->
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <div class="text-center">
                                <h6 class="text-warning">💰 Paid</h6>
                                <small>(>{{ stats.paid_threshold or 10000 }} views)</small>
                            </div>
                        </div>
                        
                        {% for category in ['hero', 'hub', 'help'] %}
                        <div class="col-md-2 mb-3">
                            <div class="bg-light text-dark p-3 rounded">
                                <h5>{{ (stats.performance_matrix[category].paid_median / 1000)|round(1) }}k views</h5>
                                <small>({{ stats.performance_matrix[category].paid_count }} videos)</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart me-2"></i>Distribution HUB • HERO • HELP</h5>
                </div>
                <div class="card-body" style="height: 365px;">
                    <div style="position: relative; height: 310px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart me-2"></i>Organic vs Paid</h5>
                </div>
                <div class="card-body" style="height: 365px;">
                    <div style="position: relative; height: 310px;">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- ======= ONGLETS VIDÉOS (HERO • HUB • HELP) ======= -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-play-circle me-2"></i>Video Analysis</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="nav nav-tabs" id="analysisTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="analysis-hero-tab" data-bs-toggle="tab" data-bs-target="#hero" type="button">
                                🔥 HERO ({{ stats.hero_count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analysis-hub-tab" data-bs-toggle="tab" data-bs-target="#hub" type="button">
                                🏠 HUB ({{ stats.hub_count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="analysis-help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button">
                                🆘 HELP ({{ stats.help_count }})
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="analysisTabContent">
                        {% for category in ['hero', 'hub', 'help'] %}
                        <div class="tab-pane fade {% if category == 'hero' %}show active{% endif %}" id="{{ category }}">
                            <div class="p-4">
                                {% if videos_by_category[category] %}
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Titre</th>
                                                <th>Views</th>
                                                <th>Likes</th>
                                                <th>Type</th>
                                                <th>Score</th>
                                                <th>Tag</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for video in videos_by_category[category][:20] %}
                                            <tr>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div>
                                                            {{ video['title'][:60] }}{% if video['title']|length > 60 %}...{% endif %}
                                                            <br>
                                                            <small class="text-muted">
                                                                {% if video['classification_confidence'] %}
                                                                    Confiance: {{ video['classification_confidence'] }}%
                                                                {% endif %}
                                                                {% if video['human_verified'] %}
                                                                    <span class="badge bg-success text-white ms-1">✅ Humain</span>
                                                                {% endif %}
                                                            </small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>{{ video['view_count']|format_number if video['view_count'] else "N/A" }}</td>
                                                <td>{{ video['like_count']|format_number if video['like_count'] else "N/A" }}</td>
                                                <td>
                                                    {% set is_paid = video['view_count'] and video['view_count'] >= 10000 %}
                                                    <span class="badge {{ 'paid-badge' if is_paid else 'organic-badge' }}">
                                                        {{ 'Paid' if is_paid else 'Organic' }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if video['is_short'] %}
                                                        <span class="badge bg-warning text-dark">Short</span>
                                                    {% else %}
                                                        <span class="badge bg-info">Vidéo</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="dropdown">
                                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                            <i class="bi bi-tag"></i>
                                                        </button>
                                                        <ul class="dropdown-menu">
                                                            <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video['url'] }}', '{{ video['title'] }}', 'help')">🆘 HELP</a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video['url'] }}', '{{ video['title'] }}', 'hero')">🔥 HERO</a></li>
                                                            <li><a class="dropdown-item" href="#" onclick="tagVideo('{{ video['url'] }}', '{{ video['title'] }}', 'hub')">🏠 HUB</a></li>
                                                        </ul>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="text-center py-4">
                                    <i class="bi bi-collection-play text-muted" style="font-size: 2rem;"></i>
                                    <h6 class="text-muted mt-2">Aucune vidéo {{ category.upper() }} trouvée</h6>
                                    <p class="text-muted small">Videos will appear here once classified</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // FROM FIRST BLOCK
    // Graphique en camembert pour les catégories
    const ctx1 = document.getElementById('categoryChart')?.getContext('2d');
    if (ctx1) {
        new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: ['🔥 HERO', '🏠 HUB', '🆘 HELP'],
                datasets: [{
                    data: [{{ stats.hero_count or 0 }}, {{ stats.hub_count or 0 }}, {{ stats.help_count or 0 }}],
                    backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1'],
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 4,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 20, font: { size: 14, weight: 'bold' } }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} videos (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: { animateRotate: true, duration: 2000 }
            }
        });
    }

    // Graphique en barres pour Organic vs Paid
    const ctx2 = document.getElementById('distributionChart')?.getContext('2d');
    if (ctx2) {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: ['🌱 Organic', '💰 Paid'],
                datasets: [{
                    label: 'Number of videos',
                    data: [{{ stats.organic_count or 0 }}, {{ stats.paid_count or 0 }}],
                    backgroundColor: ['rgba(39, 174, 96, 0.8)', 'rgba(243, 156, 18, 0.8)'],
                    borderColor: ['rgba(39, 174, 96, 1)', 'rgba(243, 156, 18, 1)'],
                    borderWidth: 2,
                    borderRadius: 12,
                    borderSkipped: false,
                    hoverBackgroundColor: ['rgba(39, 174, 96, 1)', 'rgba(243, 156, 18, 1)']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                return `${context.parsed.y} videos (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.1)' }, ticks: { font: { weight: 'bold' } } },
                    x: { grid: { display: false }, ticks: { font: { size: 14, weight: 'bold' } } }
                },
                animation: { duration: 2000, easing: 'easeOutBounce' }
            }
        });
    }
    
    // Initialiser le graphique d'abonnés
    loadSubscriberChartFromServer();
    
    // Graphique en donut pour la distribution Shorts vs Long Videos
    const shortsCtx = document.getElementById('shortsChart')?.getContext('2d');
    if (shortsCtx) {
        const shortsCount = {{ shorts_data.shorts_count or 0 }};
        const longVideosCount = {{ (stats.total_videos or 0) - (shorts_data.shorts_count or 0) }};
        
        new Chart(shortsCtx, {
            type: 'doughnut',
            data: {
                labels: ['🎬 Shorts', '📹 Long Videos'],
                datasets: [{
                    data: [shortsCount, longVideosCount],
                    backgroundColor: ['#FF6B6B', '#4ECDC4'],
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 4,
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { 
                            padding: 10, 
                            font: { size: 12, weight: 'bold' },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ${context.parsed} videos (${percentage}%)`;
                            }
                        }
                    }
                },
                animation: { animateRotate: true, duration: 1500 }
            }
        });
    }

    // Événement pour le formulaire d'upload
    $('#csvUploadForm').on('submit', function(e) {
        e.preventDefault();
        var formData = new FormData(this);
        var competitorId = '{{ request.view_args.competitor_id }}';
        
        $('#csvUploadMessage').parent().removeClass('alert-success alert-danger').addClass('alert-info').show();
        $('#csvUploadMessage').html('<i class="bi bi-hourglass-split"></i> Importing...');

        $.ajax({
            url: `/competitor/${competitorId}/upload_subscribers`,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(data) {
                $('#csvUploadMessage').parent().removeClass('alert-info').addClass('alert-success');
                $('#csvUploadMessage').html(`<i class="bi bi-check-circle-fill"></i> ${data.message}`);
                // Recharger le graphique des abonnés
                loadSubscriberChartFromServer();
                setTimeout(() => { location.reload(); }, 1500);
            },
            error: function(xhr) {
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "Une erreur est survenue.";
                $('#csvUploadMessage').parent().removeClass('alert-info').addClass('alert-danger');
                $('#csvUploadMessage').html(`<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`);
            }
        });
    });
});

function loadSubscriberChartFromServer() {
    const subscriberData = {{ subscriber_data|tojson|safe }};
    
    // Debug: afficher les données dans la console
    console.log('=== DEBUG SUBSCRIBER CHART ===');
    console.log('subscriberData:', subscriberData);
    console.log('has_data:', subscriberData ? subscriberData.has_data : 'undefined');
    
    if (subscriberData && subscriberData.has_data) {
        document.getElementById('subscriberChartSection').style.display = 'block';
        const statsDiv = document.getElementById('subscriberStats');
        const stats = subscriberData.stats;
        statsDiv.innerHTML = `
            <small class="text-muted">
                <strong>${stats.total_entries}</strong> points de données<br>
                <span class="text-${stats.total_growth >= 0 ? 'success' : 'danger'}">
                    ${stats.total_growth >= 0 ? '+' : ''}${stats.total_growth.toLocaleString()} subscribers 
                    (${stats.growth_percentage >= 0 ? '+' : ''}${stats.growth_percentage}%)
                </span><br>
                <small>${stats.first_date} → ${stats.last_date}</small>
            </small>
        `;
        
        const ctx3 = document.getElementById('subscriberChart').getContext('2d');
        if (window.mySubscriberChart) {
            window.mySubscriberChart.destroy();
        }
        try {
            window.mySubscriberChart = new Chart(ctx3, {
                type: 'line',
                data: subscriberData.chart_data,
                options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { font: { size: 14, weight: 'bold' } } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toLocaleString()} subscribers`;
                            },
                            title: function(context) {
                                const date = new Date(context[0].label);
                                return date.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        display: true,
                        title: { display: true, text: 'Date' }
                    },
                    y: { 
                        beginAtZero: false,
                        title: { display: true, text: 'Subscribers' }
                    }
                }
            }
            });
            console.log('✅ Subscriber chart created successfully');
        } catch (error) {
            console.error('❌ Error creating subscriber chart:', error);
            console.error('Chart data:', subscriberData.chart_data);
        }
    } else {
        console.log('❌ No subscriber data or has_data=false');
        document.getElementById('subscriberChartSection').style.display = 'none';
    }
}

function saveCompetitorTags() {
    const competitorId = '{{ request.view_args.competitor_id }}';
    const data = {
        sector: $('#competitorSector').val(),
        region: $('#competitorRegion').val(),
        tags: $('#competitorTags').val(),
        active: $('#competitorActive').val(),
        notes: $('#competitorNotes').val()
    };

    $('#taggingMessage').parent().removeClass('alert-success alert-danger').addClass('alert-info').show();
    $('#taggingMessage').html('<i class="bi bi-hourglass-split"></i> Sauvegarde en cours...');

    $.ajax({
        url: `/competitor/${competitorId}/update_tags`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            $('#taggingMessage').parent().removeClass('alert-info').addClass('alert-success');
            $('#taggingMessage').html(`<i class="bi bi-check-circle-fill"></i> ${response.message}`);
        },
        error: function(xhr) {
            const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "Erreur lors de la sauvegarde.";
            $('#taggingMessage').parent().removeClass('alert-info').addClass('alert-danger');
            $('#taggingMessage').html(`<i class="bi bi-exclamation-triangle-fill"></i> ${errorMessage}`);
        }
    });
}

function confirmDeleteFromDetail(competitorId, competitorName) {
    if (confirm(`Are you sure you want to permanently delete the competitor "${competitorName}" and all associated data? This action is irreversible.`)) {
        window.location.href = `/competitor/${competitorId}/delete`;
    }
}

// ======================================================
// 🤖 IA Auto-Classify Playlists + Propagation vers vidéos
// ======================================================
function aiClassifyPlaylists() {
    const competitorId = '{{ competitor.id }}';
    showAlert('⏳ Classification IA en cours...', 'info');
    fetch(`/api/competitor/${competitorId}/playlists/ai-classify`, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data && data.success !== false) {
            showAlert('🎉 Videos have been successfully classified with the Sentence Transformer model', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error || 'Erreur lors de la classification IA', 'danger');
        }
    })
    .catch(err => {
        console.error(err);
        showAlert('Erreur réseau pendant la classification', 'danger');
    });
}

// ======================================================
// 🔄 Actualiser Playlists via API YouTube Data v3
// ======================================================
function refreshPlaylists() {
    const competitorId = '{{ competitor.id }}';
    const competitorName = '{{ competitor.name|e }}';
    
    // Confirmation utilisateur
    if (!confirm(`Actualiser les playlists de "${competitorName}" via l'API YouTube ?\n\n⚠️ Cela consomme du quota API (≈150 unités)`)) {
        return;
    }
    
    // Désactiver le bouton pendant l'opération
    const refreshBtn = document.querySelector('button[onclick="refreshPlaylists()"]');
    if (refreshBtn) {
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Actualisation...';
    }
    
    fetch(`/api/competitor/${competitorId}/playlists/refresh`, {
        method: 'POST',
        headers: { 
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data && data.success) {
            alert(`✅ ${data.message}`);
            setTimeout(() => location.reload(), 1000);
        } else {
            alert(`❌ ${data.error || 'Erreur lors de l\'actualisation'}`);
            // Réactiver le bouton en cas d'erreur
            if (refreshBtn) {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Actualiser<small class="text-muted d-block" style="font-size: 0.7em;">⚠️ API YouTube</small>';
            }
        }
    })
    .catch(err => {
        console.error('Erreur actualisation playlists:', err);
        alert('❌ Erreur réseau pendant l\'actualisation');
        // Réactiver le bouton en cas d'erreur
        if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="bi bi-arrow-repeat me-1"></i>Actualiser<small class="text-muted d-block" style="font-size: 0.7em;">⚠️ API YouTube</small>';
        }
    });
}

// Fonctions simplifiées - les petits graphiques ont été supprimés

function onCsvUploadSuccess(data) {
    document.dispatchEvent(new CustomEvent('csvDataUpdated', { detail: data }));
    if (data.subscriberCount) {
        const subscribersCountElement = document.getElementById('subscribersCount');
        if (subscribersCountElement) {
            const count = data.subscriberCount >= 1000 ? (data.subscriberCount / 1000).toFixed(1) + 'K' : data.subscriberCount;
            subscribersCountElement.textContent = count;
        }
    }
    setTimeout(() => { location.reload(); }, 2000);
}

</script>
{% endblock %} 