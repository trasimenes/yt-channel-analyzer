{% extends "sneat_base_layout.html" %}

{% block title %}Fix Problems - YT Analyzer{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Header -->
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-6">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <div>
                        <h5 class="card-title mb-0">
                            <i class="bx bx-wrench me-2"></i>
                            Fix Problems - Maintenance Syst√®me
                        </h5>
                        <p class="card-subtitle text-muted mb-0">Outils de correction, classification et maintenance</p>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="location.reload()">
                            <i class="bx bx-refresh"></i>
                            <span class="d-none d-sm-inline-block ms-1">Refresh</span>
                        </button>
                        <a href="/settings" class="btn btn-sm btn-outline-secondary">
                            <i class="bx bx-cog"></i>
                            <span class="d-none d-sm-inline-block ms-1">Settings</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bx bx-check-circle me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Unified Fix Everything -->
    <div class="row mb-6">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bx bx-zap me-2"></i>
                        Fix Everything - Correction Unifi√©e
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning p-3 mb-4">
                        <div class="d-flex align-items-start">
                            <i class="bx bx-info-circle me-2 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Service Unifi√© de Correction</h6>
                                <small>S√©lectionnez les corrections √† appliquer. Le syst√®me respecte la hi√©rarchie : ü•á Humain > ü•à IA > ü•â Patterns.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Fix Selection -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">
                                <i class="bx bx-list-check me-2"></i>
                                Corrections Disponibles
                            </h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="data_integrity" id="fix-data-integrity" checked>
                                <label class="form-check-label" for="fix-data-integrity">
                                    <strong>Int√©grit√© des donn√©es</strong> - Validation et correction automatique
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="youtube_dates" id="fix-youtube-dates" checked>
                                <label class="form-check-label" for="fix-youtube-dates">
                                    <strong>Dates YouTube</strong> - Correction des dates de publication
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="missing_data" id="fix-missing-data">
                                <label class="form-check-label" for="fix-missing-data">
                                    <strong>Donn√©es manquantes</strong> - Compl√©ter les m√©tadonn√©es
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="orphan_data" id="fix-orphan-data">
                                <label class="form-check-label" for="fix-orphan-data">
                                    <strong>Donn√©es orphelines</strong> - Nettoyer les r√©f√©rences cass√©es
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">
                                <i class="bx bx-brain me-2"></i>
                                Classifications & IA
                            </h6>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="human_propagation" id="fix-human-propagation" checked>
                                <label class="form-check-label" for="fix-human-propagation">
                                    <strong>Propagation humaine</strong> - Appliquer les validations manuelles
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="reclassify_videos" id="fix-reclassify-videos">
                                <label class="form-check-label" for="fix-reclassify-videos">
                                    <strong>Re-classification vid√©os</strong> - Logique multilingue IA
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="classify_playlists" id="fix-classify-playlists">
                                <label class="form-check-label" for="fix-classify-playlists">
                                    <strong>Classification playlists</strong> - Auto-classification IA
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="classification_tracking" id="fix-classification-tracking">
                                <label class="form-check-label" for="fix-classification-tracking">
                                    <strong>Tracking classifications</strong> - Mise √† jour des m√©tadonn√©es
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" value="final_validation" id="fix-final-validation" checked>
                                <label class="form-check-label" for="fix-final-validation">
                                    <strong>Validation finale</strong> - Rapport d'int√©grit√© complet
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Parameters -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label for="api-limit" class="form-label">API Limit</label>
                            <input type="number" class="form-control" id="api-limit" value="100" min="10" max="1000">
                            <small class="text-muted">Limite pour les appels YouTube API</small>
                        </div>
                        <div class="col-md-4">
                            <label for="batch-size" class="form-label">Batch Size</label>
                            <input type="number" class="form-control" id="batch-size" value="50" min="10" max="100">
                            <small class="text-muted">Taille des lots de traitement</small>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-3 mt-4">
                                <button class="btn btn-primary" onclick="runUnifiedFix()">
                                    <i class="bx bx-play me-2"></i>Lancer Fix Everything
                                </button>
                                <button class="btn btn-outline-secondary" onclick="selectAllFixes()">
                                    <i class="bx bx-check-square me-2"></i>Tout S√©lectionner
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Progress Display -->
                    <div id="unified-fix-progress" class="mt-4" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div id="unified-fix-progress-bar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" 
                                 style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="unified-fix-status" class="text-center mt-2">
                            <small class="text-muted">Initialisation...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Classification Patterns Management -->
    <div class="row mb-6">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bx bx-shield-check me-2"></i>
                        Gestion des Patterns de Classification
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info p-3 mb-4">
                        <div class="d-flex align-items-start">
                            <i class="bx bx-info-circle me-2 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Patterns Multilingues HERO/HUB/HELP</h6>
                                <small>Gestion des mots-cl√©s de classification en fran√ßais, anglais, allemand et n√©erlandais.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Patterns Actions -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <div class="avatar mx-auto mb-3">
                                        <span class="avatar-initial rounded bg-label-primary">
                                            <i class="bx bx-arrow-repeat"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-2">Propager Patterns</h6>
                                    <p class="small text-muted mb-3">Appliquer les patterns √† toutes les classifications</p>
                                    <button class="btn btn-primary" onclick="propagatePatterns()">
                                        <i class="bx bx-arrow-repeat me-2"></i>Propager
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <div class="avatar mx-auto mb-3">
                                        <span class="avatar-initial rounded bg-label-warning">
                                            <i class="bx bx-robot"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-2">Re-classifier Tout</h6>
                                    <p class="small text-muted mb-3">Re-classification compl√®te avec logique multilingue</p>
                                    <button class="btn btn-warning" onclick="reclassifyAllVideos()">
                                        <i class="bx bx-robot me-2"></i>Re-classifier
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <div class="avatar mx-auto mb-3">
                                        <span class="avatar-initial rounded bg-label-success">
                                            <i class="bx bx-test-tube"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-2">Tester Patterns</h6>
                                    <p class="small text-muted mb-3">Valider l'efficacit√© des patterns</p>
                                    <button class="btn btn-success" onclick="testPatterns()">
                                        <i class="bx bx-test-tube me-2"></i>Tester
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pattern Progress -->
                    <div id="pattern-progress" class="mt-4" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div id="pattern-progress-bar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                 role="progressbar" 
                                 style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="pattern-status" class="text-center mt-2">
                            <small class="text-muted">Pr√©paration...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Analysis -->
    <div class="row mb-6">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bx bx-trending-up me-2"></i>
                        Topic Analysis - Analyse Automatique
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info p-3 mb-4">
                        <div class="d-flex align-items-start">
                            <i class="bx bx-trending-up me-2 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-1">Analyse des Topics des Vid√©os</h6>
                                <small>Analyse automatique des 5500+ vid√©os pour extraire les topics populaires et tendances.</small>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Stats -->
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body">
                                    <div class="avatar mx-auto mb-2">
                                        <span class="avatar-initial rounded bg-label-success">
                                            <i class="bx bx-check-circle"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-1">Status</h6>
                                    <span class="fw-medium" id="topic-analyzer-status">Actif</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body">
                                    <div class="avatar mx-auto mb-2">
                                        <span class="avatar-initial rounded bg-label-info">
                                            <i class="bx bx-video"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-1">Vid√©os Analys√©es</h6>
                                    <span class="fw-medium" id="topics-analyzed-count">{{ analyzed_videos or '0' }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-warning">
                                <div class="card-body">
                                    <div class="avatar mx-auto mb-2">
                                        <span class="avatar-initial rounded bg-label-warning">
                                            <i class="bx bx-hash"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-1">Topics Trouv√©s</h6>
                                    <span class="fw-medium" id="topics-found-count">{{ total_topics or '0' }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <div class="avatar mx-auto mb-2">
                                        <span class="avatar-initial rounded bg-label-primary">
                                            <i class="bx bx-calendar"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-1">Derni√®re Analyse</h6>
                                    <span class="fw-medium">{{ last_topic_analysis or 'Jamais' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Actions -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <div class="avatar mx-auto mb-3">
                                        <span class="avatar-initial rounded bg-label-primary">
                                            <i class="bx bx-play"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-2">Analyser Maintenant</h6>
                                    <p class="small text-muted mb-3">Lance une analyse compl√®te des topics</p>
                                    <button class="btn btn-primary" onclick="runTopicAnalysisNow()">
                                        <i class="bx bx-play me-2"></i>D√©marrer Analyse
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <div class="avatar mx-auto mb-3">
                                        <span class="avatar-initial rounded bg-label-secondary">
                                            <i class="bx bx-cog"></i>
                                        </span>
                                    </div>
                                    <h6 class="mb-2">Configuration</h6>
                                    <p class="small text-muted mb-3">Param√®tres d'analyse et fr√©quence</p>
                                    <button class="btn btn-outline-secondary" onclick="configureTopicAnalyzer()">
                                        <i class="bx bx-cog me-2"></i>Configure
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Analysis Progress -->
                    <div id="topic-analysis-progress" class="mt-4" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div id="topic-analysis-progress-bar" 
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                 role="progressbar" 
                                 style="width: 0%">
                                0%
                            </div>
                        </div>
                        <div id="topic-analysis-status" class="text-center mt-2">
                            <small class="text-muted">Pr√©paration...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="row mb-6">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="bx bx-server me-2"></i>
                        Statut Syst√®me
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <i class="bx bx-data bx-lg text-primary mb-2"></i>
                                <h6 class="mb-1">Base de Donn√©es</h6>
                                <span class="badge bg-success">Connect√©e</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <i class="bx bx-brain bx-lg text-info mb-2"></i>
                                <h6 class="mb-1">IA Models</h6>
                                <span class="badge bg-success">Actifs</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <i class="bx bx-cloud bx-lg text-warning mb-2"></i>
                                <h6 class="mb-1">YouTube API</h6>
                                <span class="badge bg-success">Disponible</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3">
                                <i class="bx bx-cog bx-lg text-secondary mb-2"></i>
                                <h6 class="mb-1">Maintenance</h6>
                                <span class="badge bg-success">Op√©rationnel</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Fix Problems -->
<script>
// Unified Fix Everything
function runUnifiedFix() {
    const selectedFixes = [];
    document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
        selectedFixes.push(checkbox.value);
    });
    
    if (selectedFixes.length === 0) {
        alert('Veuillez s√©lectionner au moins une correction.');
        return;
    }
    
    if (!confirm(`Voulez-vous ex√©cuter Fix Everything avec ${selectedFixes.length} corrections ? Cette op√©ration peut prendre du temps.`)) {
        return;
    }
    
    const progressDiv = document.getElementById('unified-fix-progress');
    const progressBar = document.getElementById('unified-fix-progress-bar');
    const statusDiv = document.getElementById('unified-fix-status');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    statusDiv.innerHTML = '<small class="text-info">üîÑ D√©marrage des corrections...</small>';
    
    const payload = {
        selected_fixes: selectedFixes,
        api_limit: parseInt(document.getElementById('api-limit').value),
        batch_size: parseInt(document.getElementById('batch-size').value)
    };
    
    fetch('/api/fix-all-problems', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            statusDiv.innerHTML = `<small class="text-success">‚úÖ ${data.message}</small>`;
            
            // Afficher les stats si disponibles
            if (data.stats) {
                const stats = data.stats;
                statusDiv.innerHTML += `<br><small class="text-info">üìä Probl√®mes corrig√©s: ${stats.problems_fixed}, Donn√©es: ${stats.data_fixed}, Classifications: ${stats.classifications_fixed}</small>`;
            }
            
            setTimeout(() => {
                progressDiv.style.display = 'none';
                location.reload();
            }, 5000);
        } else {
            progressBar.classList.add('bg-danger');
            statusDiv.innerHTML = `<small class="text-danger">‚ùå Erreur: ${data.error}</small>`;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        progressBar.classList.add('bg-danger');
        statusDiv.innerHTML = `<small class="text-danger">‚ùå Erreur de connexion</small>`;
    });
}

function selectAllFixes() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    
    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });
}

// Pattern Management Functions
function propagatePatterns() {
    if (!confirm('Propager les patterns multilingues ? Cette op√©ration va re-classifier selon la nouvelle logique.')) {
        return;
    }
    
    showPatternProgress('üîÑ Propagation des patterns...');
    
    fetch('/api/propagate-patterns', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePatternProgress(100, '‚úÖ Patterns propag√©s avec succ√®s!');
            } else {
                updatePatternProgress(0, `‚ùå Erreur: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            updatePatternProgress(0, '‚ùå Erreur de connexion', 'danger');
        });
}

function reclassifyAllVideos() {
    if (!confirm('Re-classifier toutes les vid√©os avec la logique multilingue ? Cette op√©ration peut prendre du temps.')) {
        return;
    }
    
    showPatternProgress('ü§ñ Re-classification en cours...');
    
    fetch('/api/reclassify-all-videos', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePatternProgress(100, `‚úÖ ${data.message}`);
            } else {
                updatePatternProgress(0, `‚ùå Erreur: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            updatePatternProgress(0, '‚ùå Erreur de connexion', 'danger');
        });
}

function testPatterns() {
    showPatternProgress('üß™ Test des patterns...');
    
    fetch('/api/test-patterns', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePatternProgress(100, `‚úÖ Test termin√©: ${data.results?.length || 0} patterns test√©s`);
            } else {
                updatePatternProgress(0, `‚ùå Erreur: ${data.error}`, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            updatePatternProgress(0, '‚ùå Erreur de connexion', 'danger');
        });
}

function showPatternProgress(message) {
    const progressDiv = document.getElementById('pattern-progress');
    const progressBar = document.getElementById('pattern-progress-bar');
    const statusDiv = document.getElementById('pattern-status');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '50%';
    progressBar.textContent = '50%';
    progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
    statusDiv.innerHTML = `<small class="text-info">${message}</small>`;
}

function updatePatternProgress(percent, message, type = 'success') {
    const progressBar = document.getElementById('pattern-progress-bar');
    const statusDiv = document.getElementById('pattern-status');
    
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';
    
    if (type === 'danger') {
        progressBar.className = 'progress-bar bg-danger';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }
    
    statusDiv.innerHTML = `<small class="text-${type}">${message}</small>`;
    
    if (percent === 100 || type === 'danger') {
        setTimeout(() => {
            document.getElementById('pattern-progress').style.display = 'none';
        }, 3000);
    }
}

// Topic Analysis Functions
function runTopicAnalysisNow() {
    if (!confirm('Voulez-vous analyser tous les topics maintenant ? Cette op√©ration peut prendre 10-15 minutes pour analyser 5500+ vid√©os.')) {
        return;
    }
    
    const progressDiv = document.getElementById('topic-analysis-progress');
    const progressBar = document.getElementById('topic-analysis-progress-bar');
    const statusDiv = document.getElementById('topic-analysis-status');
    
    progressDiv.style.display = 'block';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    statusDiv.innerHTML = '<small class="text-info">üîÑ D√©marrage de l\'analyse des topics...</small>';
    
    fetch('/api/start-topic-analysis', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const taskId = data.task_id;
                statusDiv.innerHTML = '<small class="text-info">üìä Analyse en cours...</small>';
                
                // Polling pour suivre le progr√®s
                const checkProgress = () => {
                    fetch(`/api/topic-analysis-progress/${taskId}`)
                        .then(response => response.json())
                        .then(progressData => {
                            const progress = progressData.progress || 0;
                            progressBar.style.width = progress + '%';
                            progressBar.textContent = progress + '%';
                            statusDiv.innerHTML = `<small class="text-info">${progressData.status || 'En cours...'}</small>`;
                            
                            if (progressData.completed) {
                                progressBar.classList.remove('progress-bar-animated');
                                progressBar.classList.add('bg-success');
                                statusDiv.innerHTML = '<small class="text-success">‚úÖ Analyse termin√©e avec succ√®s!</small>';
                                
                                // Mettre √† jour les compteurs
                                document.getElementById('topics-analyzed-count').textContent = progressData.videos_analyzed || '0';
                                document.getElementById('topics-found-count').textContent = progressData.topics_found || '0';
                                
                                setTimeout(() => {
                                    progressDiv.style.display = 'none';
                                    location.reload();
                                }, 3000);
                            } else if (progressData.error) {
                                progressBar.classList.add('bg-danger');
                                statusDiv.innerHTML = `<small class="text-danger">‚ùå Erreur: ${progressData.error}</small>`;
                            } else {
                                setTimeout(checkProgress, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Progress check error:', error);
                            statusDiv.innerHTML = '<small class="text-danger">‚ùå Erreur de suivi</small>';
                        });
                };
                
                setTimeout(checkProgress, 2000);
            } else {
                statusDiv.innerHTML = `<small class="text-danger">‚ùå Erreur: ${data.error}</small>`;
                progressDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            statusDiv.innerHTML = `<small class="text-danger">‚ùå Erreur de connexion</small>`;
            progressDiv.style.display = 'none';
        });
}

function configureTopicAnalyzer() {
    const config = {
        schedule: prompt('Heure d\'ex√©cution quotidienne (format 24h, ex: 03:00):', '03:00'),
        maxVideos: prompt('Nombre maximum de vid√©os √† analyser:', '5500'),
        includeDescriptions: confirm('Inclure les descriptions dans l\'analyse ? (plus lent mais plus pr√©cis)')
    };
    
    if (config.schedule && config.maxVideos) {
        fetch('/api/configure-topic-analyzer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Configuration Topic Analyzer mise √† jour');
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur de connexion');
        });
    }
}
</script>
{% endblock %}