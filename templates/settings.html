{% extends "base.html" %}

{% block title %}Settings - YT Analyzer{% endblock %}

{% block extra_css %}
<style>
    .pattern-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 4px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        font-size: 0.9rem;
    }
    
    .pattern-line:hover {
        background-color: #e9ecef;
    }
    
    .pattern-text {
        flex: 1;
        color: #495057;
    }
    
    .pattern-container {
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title">
                        <i class="bi bi-gear text-primary me-3"></i>
                        Settings
                    </h1>
                    <p class="text-muted mb-0">Configure business rules and classification parameters</p>
                </div>

                {% if message %}
                <div class="alert alert-success alert-custom alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}

                <!-- Main Settings Form -->
                <form method="POST" class="settings-form">
                    <div class="card settings-card">
                        <div class="card-header card-header-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-sliders me-2"></i>
                                Analysis Configuration
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="paid_threshold" class="form-label">
                                            <i class="bi bi-currency-dollar me-2"></i>
                                            Paid Content Threshold
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="paid_threshold" 
                                               name="paid_threshold" 
                                               value="{{ current_settings.paid_threshold or 10000 }}"
                                               min="1000" 
                                               max="1000000"
                                               step="1000">
                                        <div class="form-text">Videos above this view count are considered "paid" content</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="industry" class="form-label">
                                            <i class="bi bi-building me-2"></i>
                                            Industry Focus
                                        </label>
                                        <select class="form-select" id="industry" name="industry">
                                            <option value="tourism" {% if current_settings.industry == 'tourism' %}selected{% endif %}>Tourism & Travel</option>
                                            <option value="hospitality" {% if current_settings.industry == 'hospitality' %}selected{% endif %}>Hospitality</option>
                                            <option value="retail" {% if current_settings.industry == 'retail' %}selected{% endif %}>Retail & E-commerce</option>
                                            <option value="tech" {% if current_settings.industry == 'tech' %}selected{% endif %}>Technology</option>
                                            <option value="finance" {% if current_settings.industry == 'finance' %}selected{% endif %}>Finance</option>
                                            <option value="healthcare" {% if current_settings.industry == 'healthcare' %}selected{% endif %}>Healthcare</option>
                                            <option value="education" {% if current_settings.industry == 'education' %}selected{% endif %}>Education</option>
                                            <option value="entertainment" {% if current_settings.industry == 'entertainment' %}selected{% endif %}>Entertainment</option>
                                        </select>
                                        <div class="form-text">Industry-specific classification patterns</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="max_videos" class="form-label">
                                            <i class="bi bi-film me-2"></i>
                                            Maximum Videos per Channel
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="max_videos" 
                                               name="max_videos" 
                                               value="{{ current_settings.max_videos or 1000 }}"
                                               min="50" 
                                               max="5000"
                                               step="50">
                                        <div class="form-text">Limit analysis to most recent videos</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="cache_duration" class="form-label">
                                            <i class="bi bi-clock me-2"></i>
                                            Cache Duration (hours)
                                        </label>
                                        <input type="number" 
                                               class="form-control" 
                                               id="cache_duration" 
                                               name="cache_duration" 
                                               value="{{ current_settings.cache_duration or 24 }}"
                                               min="1" 
                                               max="168"
                                               step="1">
                                        <div class="form-text">How long to cache video data</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input me-3" 
                                       type="checkbox" 
                                       role="switch" 
                                       id="auto_classify"
                                       name="auto_classify"
                                       {% if current_settings.auto_classify %}checked{% endif %}>
                                <div>
                                    <label class="form-check-label fw-bold" for="auto_classify">
                                        Automatic AI classification
                                    </label>
                                    <div class="form-text">
                                        Enable automatic video classification using the HUB/HERO/HELP framework
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Semantic Classification Section -->
                    <div class="card settings-card">
                        <div class="card-header card-header-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-brain me-2"></i>
                                Semantic Classification (AI)
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning alert-custom" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Classification Avanc√©e par IA</strong>
                                <p class="mb-0 mt-2">Le syst√®me s√©mantique utilise sentence-transformers pour comprendre le sens des textes. Il est d√©sactiv√© par d√©faut pour √©viter les ralentissements.</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-toggle-on me-2"></i>
                                            Mode de Classification
                                        </label>
                                        <select class="form-select" id="classification_mode" name="classification_mode">
                                            <option value="database_only">Base de donn√©es uniquement (rapide)</option>
                                            <option value="hybrid">Hybride patterns + s√©mantique</option>
                                            <option value="semantic_only">S√©mantique uniquement (lent)</option>
                                        </select>
                                        <div class="form-text">Mode actuel : <span id="current_mode">Chargement...</span></div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-cpu me-2"></i>
                                            Mod√®le S√©mantique
                                        </label>
                                        <select class="form-select" id="semantic_model" name="semantic_model">
                                            <option value="all-MiniLM-L6-v2">all-MiniLM-L6-v2 (l√©ger, 22MB)</option>
                                            <option value="all-MiniLM-L12-v2">all-MiniLM-L12-v2 (pr√©cis, 33MB)</option>
                                            <option value="all-mpnet-base-v2">all-mpnet-base-v2 (performant, 109MB)</option>
                                        </select>
                                        <div class="form-text">Mod√®le pour la compr√©hension s√©mantique</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="semantic_weight" class="form-label">
                                            <i class="bi bi-sliders me-2"></i>
                                            Poids S√©mantique
                                        </label>
                                        <input type="range" 
                                               class="form-range" 
                                               id="semantic_weight" 
                                               name="semantic_weight"
                                               min="0" 
                                               max="1" 
                                               step="0.1" 
                                               value="0.7">
                                        <div class="form-text">
                                            Influence du s√©mantique : <span id="semantic_weight_value">70%</span> 
                                            | Patterns : <span id="pattern_weight_value">30%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <div class="d-flex align-items-center">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" 
                                                       type="checkbox" 
                                                       role="switch" 
                                                       id="semantic_enabled">
                                                <label class="form-check-label fw-bold" for="semantic_enabled">
                                                    Classification s√©mantique active
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-text mt-2">
                                            Statut : <span id="semantic_status" class="badge bg-secondary">Chargement...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="semantic-actions">
                                <h6><i class="bi bi-lightning me-2"></i>Actions S√©mantiques</h6>
                                <div class="d-flex gap-3 flex-wrap">
                                    <button type="button" 
                                            class="btn btn-primary" 
                                            id="save_semantic_settings">
                                        <i class="bi bi-check-circle me-2"></i>
                                        Sauvegarder Param√®tres
                                    </button>
                                    
                                    <button type="button" 
                                            class="btn btn-warning" 
                                            id="propagate_semantic"
                                            data-bs-toggle="tooltip"
                                            title="Applique la classification s√©mantique √† toutes les vid√©os non classifi√©es par l'humain">
                                        <i class="bi bi-broadcast me-2"></i>
                                        Propager Classification
                                    </button>
                                    
                                    <button type="button" 
                                            class="btn btn-danger" 
                                            id="force_reclassify"
                                            data-bs-toggle="tooltip"
                                            title="Force la reclassification de TOUTES les vid√©os (attention : peut prendre du temps)">
                                        <i class="bi bi-arrow-clockwise me-2"></i>
                                        Forcer Reclassification
                                    </button>
                                </div>
                                
                                <div class="mt-3">
                                    <div class="progress" id="semantic_progress" style="display: none;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" 
                                             style="width: 0%">
                                            <span id="progress_text">0%</span>
                                        </div>
                                    </div>
                                    <div class="text-muted mt-2" id="semantic_status_text" style="display: none;">
                                        Traitement en cours...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Classification Patterns Section -->
                    <div class="card settings-card">
                        <div class="card-header card-header-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-tags me-2"></i>
                                Multilingual Classification Patterns
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info alert-custom" role="alert">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Configure keywords for automatic video classification in multiple languages</strong>
                                <p class="mb-0 mt-2">These patterns are used to automatically classify videos into HERO, HUB, or HELP categories based on their titles and descriptions.</p>
                            </div>
                            
                            <ul class="nav nav-pills mb-4" id="language-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="french-tab" data-bs-toggle="pill" data-bs-target="#french-patterns" type="button">
                                        üá´üá∑ Fran√ßais
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="english-tab" data-bs-toggle="pill" data-bs-target="#english-patterns" type="button">
                                        üá¨üáß English
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="german-tab" data-bs-toggle="pill" data-bs-target="#german-patterns" type="button">
                                        üá©üá™ Deutsch
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="dutch-tab" data-bs-toggle="pill" data-bs-target="#dutch-patterns" type="button">
                                        üá≥üá± Nederlands
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content" id="language-tabContent">
                                <!-- French Patterns -->
                                <div class="tab-pane fade show active" id="french-patterns" role="tabpanel">
                                    <div class="language-patterns-container" data-language="fr">
                                        <!-- Sub-tabs for categories -->
                                        <ul class="nav nav-pills nav-pills-sm mb-3" id="french-category-tabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="fr-help-tab" data-bs-toggle="pill" data-bs-target="#fr-help" type="button">
                                                    üÜò HELP
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="fr-hero-tab" data-bs-toggle="pill" data-bs-target="#fr-hero" type="button">
                                                    üî• HERO
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="fr-hub-tab" data-bs-toggle="pill" data-bs-target="#fr-hub" type="button">
                                                    üè† HUB
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="french-category-tabContent">
                                            <div class="tab-pane fade show active" id="fr-help" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-fr-help-pattern" placeholder="Nouveau pattern HELP (ex: comment, aide, tutoriel)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('help', 'fr')">
                                                        <i class="bi bi-plus"></i> Ajouter
                                                    </button>
                                                </div>
                                                <div id="fr-help-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Chargement...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="fr-hero" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-fr-hero-pattern" placeholder="Nouveau pattern HERO (ex: exclusif, premium, luxe)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hero', 'fr')">
                                                        <i class="bi bi-plus"></i> Ajouter
                                                    </button>
                                                </div>
                                                <div id="fr-hero-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Chargement...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="fr-hub" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-fr-hub-pattern" placeholder="Nouveau pattern HUB (ex: √©pisode, s√©rie, d√©couverte)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hub', 'fr')">
                                                        <i class="bi bi-plus"></i> Ajouter
                                                    </button>
                                                </div>
                                                <div id="fr-hub-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Chargement...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- English Patterns -->
                                <div class="tab-pane fade" id="english-patterns" role="tabpanel">
                                    <div class="language-patterns-container" data-language="en">
                                        <!-- Sub-tabs for categories -->
                                        <ul class="nav nav-pills nav-pills-sm mb-3" id="english-category-tabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="en-help-tab" data-bs-toggle="pill" data-bs-target="#en-help" type="button">
                                                    üÜò HELP
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="en-hero-tab" data-bs-toggle="pill" data-bs-target="#en-hero" type="button">
                                                    üî• HERO
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="en-hub-tab" data-bs-toggle="pill" data-bs-target="#en-hub" type="button">
                                                    üè† HUB
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="english-category-tabContent">
                                            <div class="tab-pane fade show active" id="en-help" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-en-help-pattern" placeholder="New HELP pattern (e.g., how to, tutorial)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('help', 'en')">
                                                        <i class="bi bi-plus"></i> Add
                                                    </button>
                                                </div>
                                                <div id="en-help-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Loading...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="en-hero" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-en-hero-pattern" placeholder="New HERO pattern (e.g., best, exclusive)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hero', 'en')">
                                                        <i class="bi bi-plus"></i> Add
                                                    </button>
                                                </div>
                                                <div id="en-hero-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Loading...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="en-hub" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-en-hub-pattern" placeholder="New HUB pattern (e.g., episode, series)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hub', 'en')">
                                                        <i class="bi bi-plus"></i> Add
                                                    </button>
                                                </div>
                                                <div id="en-hub-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Loading...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- German Patterns -->
                                <div class="tab-pane fade" id="german-patterns" role="tabpanel">
                                    <div class="language-patterns-container" data-language="de">
                                        <!-- Sub-tabs for categories -->
                                        <ul class="nav nav-pills nav-pills-sm mb-3" id="german-category-tabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="de-help-tab" data-bs-toggle="pill" data-bs-target="#de-help" type="button">
                                                    üÜò HELP
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="de-hero-tab" data-bs-toggle="pill" data-bs-target="#de-hero" type="button">
                                                    üî• HERO
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="de-hub-tab" data-bs-toggle="pill" data-bs-target="#de-hub" type="button">
                                                    üè† HUB
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="german-category-tabContent">
                                            <div class="tab-pane fade show active" id="de-help" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-de-help-pattern" placeholder="Neues HELP-Muster (z.B. wie, hilfe, tutorial)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('help', 'de')">
                                                        <i class="bi bi-plus"></i> Hinzuf√ºgen
                                                    </button>
                                                </div>
                                                <div id="de-help-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="de-hero" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-de-hero-pattern" placeholder="Neues HERO-Muster (z.B. beste, exklusiv)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hero', 'de')">
                                                        <i class="bi bi-plus"></i> Hinzuf√ºgen
                                                    </button>
                                                </div>
                                                <div id="de-hero-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="de-hub" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-de-hub-pattern" placeholder="Neues HUB-Muster (z.B. episode, serie)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hub', 'de')">
                                                        <i class="bi bi-plus"></i> Hinzuf√ºgen
                                                    </button>
                                                </div>
                                                <div id="de-hub-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Dutch Patterns -->
                                <div class="tab-pane fade" id="dutch-patterns" role="tabpanel">
                                    <div class="language-patterns-container" data-language="nl">
                                        <!-- Sub-tabs for categories -->
                                        <ul class="nav nav-pills nav-pills-sm mb-3" id="dutch-category-tabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="nl-help-tab" data-bs-toggle="pill" data-bs-target="#nl-help" type="button">
                                                    üÜò HELP
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="nl-hero-tab" data-bs-toggle="pill" data-bs-target="#nl-hero" type="button">
                                                    üî• HERO
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="nl-hub-tab" data-bs-toggle="pill" data-bs-target="#nl-hub" type="button">
                                                    üè† HUB
                                                </button>
                                            </li>
                                        </ul>

                                        <div class="tab-content" id="dutch-category-tabContent">
                                            <div class="tab-pane fade show active" id="nl-help" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-nl-help-pattern" placeholder="Nieuw HELP pattern (bijv. hulp, tutorial)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('help', 'nl')">
                                                        <i class="bi bi-plus"></i> Toevoegen
                                                    </button>
                                                </div>
                                                <div id="nl-help-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="nl-hero" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-nl-hero-pattern" placeholder="Nieuw HERO pattern (bijv. beste, exclusief)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hero', 'nl')">
                                                        <i class="bi bi-plus"></i> Toevoegen
                                                    </button>
                                                </div>
                                                <div id="nl-hero-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="nl-hub" role="tabpanel">
                                                <div class="input-group mb-3">
                                                    <input type="text" class="form-control" id="new-nl-hub-pattern" placeholder="Nieuw HUB pattern (bijv. aflevering, serie)">
                                                    <button class="btn btn-success-modern" onclick="addPattern('hub', 'nl')">
                                                        <i class="bi bi-plus"></i> Toevoegen
                                                    </button>
                                                </div>
                                                <div id="nl-hub-patterns-list" class="pattern-container">
                                                    <div class="text-center text-muted">Laden...</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="d-flex justify-content-end gap-3">
                        <button type="button" class="btn btn-outline-secondary-modern" onclick="resetToDefaults()">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Reset to defaults
                        </button>
                        <button type="submit" class="btn btn-primary-modern">
                            <i class="bi bi-check-lg me-2"></i>
                            Save settings
                        </button>
                    </div>
                </form>

                <!-- Human Supervision Stats Section -->
                <div class="card settings-card mt-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-person-check-fill me-2"></i>
                            Supervision Humaine
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-secondary alert-custom" role="alert">
                            <i class="bi bi-bar-chart-line me-2"></i>
                            Suivez la progression de la classification manuelle de votre contenu.
                        </div>

                        {% if human_stats and human_stats.total_playlists > 0 and human_stats.total_videos > 0 %}
                        <!-- Playlists Progress -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold">Playlists Classifi√©es Humainement</span>
                                <span class="badge bg-primary-soft">{{ human_stats.playlist_count }} / {{ human_stats.total_playlists }}</span>
                            </div>
                            {% set playlist_percentage = (human_stats.playlist_count / human_stats.total_playlists * 100) | round(1) %}
                            {% set p_style = "width: " ~ playlist_percentage ~ "%;" %}
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                     role="progressbar" 
                                     style="{{ p_style }}" 
                                     aria-valuenow="{{ playlist_percentage }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">{{ playlist_percentage }}%</div>
                            </div>
                        </div>

                        <!-- Videos Progress -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold">Vid√©os Classifi√©es Humainement</span>
                                <span class="badge bg-success-soft">{{ human_stats.video_count }} / {{ human_stats.total_videos }}</span>
                            </div>
                            {% set video_percentage = (human_stats.video_count / human_stats.total_videos * 100) | round(1) %}
                            {% set v_style = "width: " ~ video_percentage ~ "%;" %}
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     role="progressbar" 
                                     style="{{ v_style }}" 
                                     aria-valuenow="{{ video_percentage }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">{{ video_percentage }}%</div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center p-3">
                            <p class="text-muted">Aucune donn√©e de classification humaine √† afficher pour le moment.</p>
                            <a href="{{ url_for('human_classifications') }}" class="btn btn-primary-soft">
                                <i class="bi bi-pencil-square me-2"></i>
                                Commencer la classification
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Competitor Statistics Management -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üìä Gestion des Statistiques des Concurrents</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <p class="text-muted">
                                    Les statistiques des concurrents sont <strong>pr√©calcul√©es</strong> et stock√©es en table pour des performances optimales.
                                    Elles ne sont mises √† jour qu'en cas de propagation manuelle.
                                </p>
                                
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Mode actuel :</strong> Statistiques pr√©calcul√©es (ultra-rapide)
                                    <br>
                                    <small>Derni√®re mise √† jour : Automatiquement lors des analyses</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" onclick="updateCompetitorStats()">
                                        <i class="fas fa-sync-alt"></i> Recalculer les Statistiques
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="showStatsInfo()">
                                        <i class="fas fa-chart-bar"></i> Voir les Statistiques
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Progress Bar for Updates -->
                        <div class="progress mt-3" id="statsUpdateProgress" style="display: none;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%" id="statsProgressBar">
                                <span id="statsProgressText">Pr√©paration...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Video Dates Correction Section -->
                <div class="card settings-card mt-4">
                    <div class="card-header card-header-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>
                            Correction des Dates de Publication YouTube
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info alert-custom mb-4" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Utilise l'API YouTube Data v3 pour corriger les dates de publication</strong>
                            <p class="mb-0 mt-2">
                                Actuellement, la base contient les dates d'importation des vid√©os. 
                                Ce module r√©cup√®re les vraies dates de publication YouTube pour un calcul de fr√©quence pr√©cis.
                            </p>
                        </div>

                        <!-- Status Display -->
                        <div id="dates-status" class="mb-4">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Chargement...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-3 justify-content-center">
                            <button type="button" 
                                    class="btn btn-outline-primary" 
                                    onclick="refreshDatesStatus()">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Actualiser le statut
                            </button>
                            
                            <button type="button" 
                                    class="btn btn-success" 
                                    id="correct-dates-btn"
                                    onclick="startDatesCorrection()">
                                <i class="bi bi-download me-2"></i>
                                Corriger toutes les dates
                            </button>
                        </div>

                        <!-- Progress Display -->
                        <div id="correction-progress" class="mt-4" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: 0%" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    0%
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small id="progress-text" class="text-muted">En cours...</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load patterns on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAllPatterns();
    });

    async function loadAllPatterns() {
        const languages = ['fr', 'en', 'de', 'nl'];
        const categories = ['help', 'hero', 'hub'];
        
        for (const lang of languages) {
            for (const category of categories) {
                await loadPatterns(category, lang);
            }
        }
    }

    // Competitor Statistics Management Functions
    async function updateCompetitorStats() {
        const progressContainer = document.getElementById('statsUpdateProgress');
        const progressBar = document.getElementById('statsProgressBar');
        const progressText = document.getElementById('statsProgressText');
        
        // Show progress bar
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        progressText.textContent = 'Mise √† jour des statistiques...';
        
        try {
            const response = await fetch('/api/competitors/update-stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                progressBar.style.width = '100%';
                progressText.textContent = `‚úÖ ${result.message}`;
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                    progressBar.classList.add('progress-bar-animated');
                    progressBar.classList.remove('bg-success');
                    location.reload(); // Reload to see updated stats
                }, 2000);
            } else {
                throw new Error(result.error || 'Erreur inconnue');
            }
        } catch (error) {
            progressBar.style.width = '100%';
            progressText.textContent = `‚ùå Erreur: ${error.message}`;
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
                progressBar.classList.remove('bg-danger');
            }, 3000);
        }
    }

    function showStatsInfo() {
        alert('üìä Statistiques des Concurrents\n\nLes statistiques sont pr√©calcul√©es et stock√©es en base pour des performances optimales.\nElles incluent :\n‚Ä¢ Nombre total de vid√©os\n‚Ä¢ Vues totales et moyennes\n‚Ä¢ R√©partition HERO/HUB/HELP\n‚Ä¢ Taux d\'engagement\n‚Ä¢ Dur√©e moyenne\n\nMise √† jour : Manuelle uniquement');
    }

    async function loadPatterns(category, language) {
        try {
            const response = await fetch(`/api/classification-patterns/${category}/${language}`);
            const result = await response.json();
            
            if (result.success) {
                const container = document.getElementById(`${language}-${category}-patterns-list`);
                if (container) {
                    renderPatterns(result.patterns, container, category, language);
                }
            }
        } catch (error) {
            console.error(`Error loading ${category} patterns for ${language}:`, error);
        }
    }

    function renderPatterns(patterns, container, category, language) {
        if (!patterns || patterns.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">No patterns configured</div>';
            return;
        }
        
        container.innerHTML = patterns.map(pattern => `
            <div class="pattern-line">
                <span class="pattern-text">${pattern}</span>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="removePattern('${category}', '${language}', '${pattern}')">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `).join('');
    }

    async function addPattern(category, language) {
        const inputId = `new-${language}-${category}-pattern`;
        const input = document.getElementById(inputId);
        const pattern = input.value.trim();
        
        if (!pattern) {
            showAlert('Please enter a pattern', 'warning');
            return;
        }
        
        try {
            const response = await fetch('/api/add-classification-pattern', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    language: language,
                    pattern: pattern
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                input.value = '';
                await loadPatterns(category, language);
                showAlert(`Pattern "${pattern}" added successfully`, 'success');
            } else {
                showAlert('Error adding pattern: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Error adding pattern:', error);
            showAlert('Error adding pattern', 'danger');
        }
    }

    async function removePattern(category, language, pattern) {
        try {
            const response = await fetch('/api/remove-classification-pattern', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: category,
                    language: language,
                    pattern: pattern
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                await loadPatterns(category, language);
                showAlert(`Pattern "${pattern}" removed successfully`, 'success');
            } else {
                showAlert('Error removing pattern: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Error removing pattern:', error);
            showAlert('Error removing pattern', 'danger');
        }
    }

    async function resetToDefaults() {
        if (!confirm('Are you sure you want to reset all patterns to defaults? This will remove all custom patterns.')) {
            return;
        }
        
        try {
            const response = await fetch('/api/reset-classification-patterns', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.success) {
                await loadAllPatterns();
                showAlert('Patterns reset to defaults successfully', 'success');
            } else {
                showAlert('Error resetting patterns: ' + result.error, 'danger');
            }
        } catch (error) {
            console.error('Error resetting patterns:', error);
            showAlert('Error resetting patterns', 'danger');
        }
    }

    // Fonctions pour la correction des dates
    function refreshDatesStatus() {
        const statusContainer = document.getElementById('dates-status');
        statusContainer.innerHTML = `
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
        `;

        fetch('/api/dates-correction-status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.data;
                    const percentage = Math.round(status.correction_percentage);
                    
                    let statusHtml = '';
                    
                    if (!status.column_exists) {
                        statusHtml = `
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Base de donn√©es non pr√©par√©e</strong><br>
                                La colonne pour les dates YouTube n'existe pas encore.
                            </div>
                        `;
                    } else if (status.corrected_videos === 0) {
                        statusHtml = `
                            <div class="alert alert-warning">
                                <i class="bi bi-clock-history me-2"></i>
                                <strong>Aucune date corrig√©e</strong><br>
                                ${status.total_videos} vid√©os attendent la correction de leurs dates.
                            </div>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h3 text-primary">${status.total_videos}</div>
                                    <small class="text-muted">Vid√©os totales</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-warning">${status.pending_videos}</div>
                                    <small class="text-muted">√Ä corriger</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-success">${percentage}%</div>
                                    <small class="text-muted">Corrig√©es</small>
                                </div>
                            </div>
                        `;
                    } else if (status.corrected_videos === status.total_videos) {
                        statusHtml = `
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle me-2"></i>
                                <strong>Toutes les dates sont corrig√©es !</strong><br>
                                ${status.corrected_videos} vid√©os ont leurs vraies dates de publication YouTube.
                            </div>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h3 text-primary">${status.total_videos}</div>
                                    <small class="text-muted">Vid√©os totales</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-success">${status.corrected_videos}</div>
                                    <small class="text-muted">Corrig√©es</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-success">100%</div>
                                    <small class="text-muted">Termin√©</small>
                                </div>
                            </div>
                        `;
                    } else {
                        statusHtml = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>Correction partielle</strong><br>
                                ${status.corrected_videos} vid√©os corrig√©es sur ${status.total_videos} (${percentage}%).
                            </div>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="h3 text-primary">${status.total_videos}</div>
                                    <small class="text-muted">Vid√©os totales</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-warning">${status.pending_videos}</div>
                                    <small class="text-muted">√Ä corriger</small>
                                </div>
                                <div class="col-4">
                                    <div class="h3 text-success">${percentage}%</div>
                                    <small class="text-muted">Corrig√©es</small>
                                </div>
                            </div>
                            <div class="progress mt-3">
                                <div class="progress-bar bg-success" 
                                     role="progressbar" 
                                     style="width: ${percentage}%" 
                                     aria-valuenow="${percentage}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    ${percentage}%
                                </div>
                            </div>
                        `;
                    }
                    
                    statusContainer.innerHTML = statusHtml;
                    
                    // D√©sactiver le bouton si tout est corrig√©
                    const correctBtn = document.getElementById('correct-dates-btn');
                    if (status.corrected_videos === status.total_videos) {
                        correctBtn.disabled = true;
                        correctBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Termin√©';
                    } else {
                        correctBtn.disabled = false;
                        correctBtn.innerHTML = '<i class="bi bi-download me-2"></i>Corriger toutes les dates';
                    }
                } else {
                    statusContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Erreur lors du chargement du statut: ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                statusContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-wifi-off me-2"></i>
                        Erreur de connexion lors du chargement du statut.
                    </div>
                `;
            });
    }

    function startDatesCorrection() {
        const correctBtn = document.getElementById('correct-dates-btn');
        const progressContainer = document.getElementById('correction-progress');
        const progressBar = progressContainer.querySelector('.progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // D√©sactiver le bouton et afficher le progress
        correctBtn.disabled = true;
        correctBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Correction en cours...';
        progressContainer.style.display = 'block';
        progressBar.style.width = '10%';
        progressText.textContent = 'D√©but de la correction...';
        
        fetch('/api/correct-video-dates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Succ√®s
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-success');
                progressText.textContent = data.message;
                
                // Actualiser le statut apr√®s 2 secondes
                setTimeout(() => {
                    refreshDatesStatus();
                    progressContainer.style.display = 'none';
                }, 2000);
                
                // Notification
                showAlert(data.message, 'success');
            } else {
                // Erreur
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                progressBar.classList.add('bg-danger');
                progressText.textContent = 'Erreur: ' + data.error;
                
                correctBtn.disabled = false;
                correctBtn.innerHTML = '<i class="bi bi-download me-2"></i>Corriger toutes les dates';
                
                showAlert('Erreur: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            progressBar.classList.add('bg-danger');
            progressText.textContent = 'Erreur de connexion';
            
            correctBtn.disabled = false;
            correctBtn.innerHTML = '<i class="bi bi-download me-2"></i>Corriger toutes les dates';
            
            showAlert('Erreur de connexion lors de la correction', 'danger');
        });
    }

    // === SEMANTIC CLASSIFICATION FUNCTIONS ===
    
    function loadSemanticSettings() {
        fetch('/api/semantic/settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const settings = data.settings;
                    
                    // Mettre √† jour l'interface
                    document.getElementById('classification_mode').value = settings.classification_mode || 'database_only';
                    document.getElementById('semantic_model').value = settings.semantic_model || 'all-MiniLM-L6-v2';
                    document.getElementById('semantic_weight').value = settings.semantic_weight || '0.7';
                    document.getElementById('semantic_enabled').checked = settings.semantic_classification_enabled === 'true';
                    
                    // Mettre √† jour les affichages
                    updateWeightDisplay();
                    updateCurrentMode();
                    updateSemanticStatus();
                }
            })
            .catch(error => {
                console.error('Erreur chargement param√®tres s√©mantiques:', error);
                showAlert('Erreur lors du chargement des param√®tres s√©mantiques', 'danger');
            });
    }
    
    function updateWeightDisplay() {
        const semanticWeight = parseFloat(document.getElementById('semantic_weight').value);
        const patternWeight = 1 - semanticWeight;
        
        document.getElementById('semantic_weight_value').textContent = Math.round(semanticWeight * 100) + '%';
        document.getElementById('pattern_weight_value').textContent = Math.round(patternWeight * 100) + '%';
    }
    
    function updateCurrentMode() {
        const mode = document.getElementById('classification_mode').value;
        const modeNames = {
            'database_only': 'Base uniquement',
            'hybrid': 'Hybride',
            'semantic_only': 'S√©mantique'
        };
        document.getElementById('current_mode').textContent = modeNames[mode] || mode;
    }
    
    function updateSemanticStatus() {
        const enabled = document.getElementById('semantic_enabled').checked;
        const statusElement = document.getElementById('semantic_status');
        
        if (enabled) {
            statusElement.textContent = 'Activ√©';
            statusElement.className = 'badge bg-success';
        } else {
            statusElement.textContent = 'D√©sactiv√©';
            statusElement.className = 'badge bg-secondary';
        }
    }
    
    function saveSemanticSettings() {
        const settings = {
            classification_mode: document.getElementById('classification_mode').value,
            semantic_model: document.getElementById('semantic_model').value,
            semantic_weight: document.getElementById('semantic_weight').value,
            pattern_weight: (1 - parseFloat(document.getElementById('semantic_weight').value)).toString(),
            semantic_classification_enabled: document.getElementById('semantic_enabled').checked.toString()
        };
        
        const saveBtn = document.getElementById('save_semantic_settings');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sauvegarde...';
        
        fetch('/api/semantic/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Param√®tres s√©mantiques sauvegard√©s avec succ√®s', 'success');
                updateCurrentMode();
                updateSemanticStatus();
            } else {
                showAlert('Erreur: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showAlert('Erreur lors de la sauvegarde', 'danger');
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Sauvegarder Param√®tres';
        });
    }
    
    function propagateSemantic(forceReclassify = false) {
        const btn = forceReclassify ? document.getElementById('force_reclassify') : document.getElementById('propagate_semantic');
        const progressContainer = document.getElementById('semantic_progress');
        const progressBar = progressContainer.querySelector('.progress-bar');
        const progressText = document.getElementById('progress_text');
        const statusText = document.getElementById('semantic_status_text');
        
        // D√©sactiver les boutons
        document.getElementById('propagate_semantic').disabled = true;
        document.getElementById('force_reclassify').disabled = true;
        
        btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Traitement...';
        
        // Afficher la progression
        progressContainer.style.display = 'block';
        statusText.style.display = 'block';
        progressBar.style.width = '10%';
        progressText.textContent = '10%';
        statusText.textContent = 'Initialisation de la classification s√©mantique...';
        
        const data = {
            force_reclassify: forceReclassify
        };
        
        fetch('/api/semantic/propagate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Simulation de progression (traitement en arri√®re-plan)
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
                statusText.textContent = `Propagation lanc√©e sur ${data.total_videos} vid√©os. Traitement en arri√®re-plan...`;
                
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-success');
                
                showAlert(data.message, 'success');
                
                // Masquer la progression apr√®s 5 secondes
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    statusText.style.display = 'none';
                }, 5000);
                
            } else {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressText.textContent = 'Erreur';
                statusText.textContent = 'Erreur: ' + data.error;
                
                showAlert('Erreur: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-danger');
            progressText.textContent = 'Erreur';
            statusText.textContent = 'Erreur de connexion';
            
            showAlert('Erreur de connexion lors de la propagation', 'danger');
        })
        .finally(() => {
            // R√©activer les boutons
            document.getElementById('propagate_semantic').disabled = false;
            document.getElementById('force_reclassify').disabled = false;
            
            document.getElementById('propagate_semantic').innerHTML = '<i class="bi bi-broadcast me-2"></i>Propager Classification';
            document.getElementById('force_reclassify').innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Forcer Reclassification';
        });
    }
    
    // Event listeners pour les param√®tres s√©mantiques
    document.addEventListener('DOMContentLoaded', function() {
        // Charger les param√®tres s√©mantiques
        loadSemanticSettings();
        
        // Event listeners
        document.getElementById('semantic_weight').addEventListener('input', updateWeightDisplay);
        document.getElementById('classification_mode').addEventListener('change', updateCurrentMode);
        document.getElementById('semantic_enabled').addEventListener('change', updateSemanticStatus);
        
        document.getElementById('save_semantic_settings').addEventListener('click', saveSemanticSettings);
        document.getElementById('propagate_semantic').addEventListener('click', () => propagateSemantic(false));
        document.getElementById('force_reclassify').addEventListener('click', () => {
            if (confirm('√ätes-vous s√ªr de vouloir forcer la reclassification de TOUTES les vid√©os ? Cette op√©ration peut prendre beaucoup de temps.')) {
                propagateSemantic(true);
            }
        });
        
        // Initialiser les tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });

    // Charger le statut au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        loadAllPatterns();
        refreshDatesStatus();
    });
</script>
{% endblock %} 